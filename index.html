<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>초성왕</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            overscroll-behavior: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 50%, #fab1a0 100%);
            color: #2d3436;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        body.time-warning {
            animation: urgentBlink 1s ease-in-out infinite;
        }

        @keyframes urgentBlink {
            0%, 100% { background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 50%, #fab1a0 100%); }
            50% { background: linear-gradient(135deg, #ff7675 0%, #fd79a8 50%, #fab1a0 100%); }
        }

        /* ===== PC 버전 (기본 - 원본 디자인) ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 600px;
            padding: 15px 20px;
            background: white;
            border-radius: 25px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #fd79a8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .audio-controls {
            display: flex;
            gap: 6px;
        }

        .audio-btn {
            padding: 6px 10px;
            background: #f5f5f5;
            border: 2px solid #dfe6e9;
            border-radius: 15px;
            color: #636e72;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-btn.active {
            background: #ffeaa7;
            border-color: #fdcb6e;
            color: #2d3436;
        }

        .multiplayer-header-btn {
            padding: 6px 12px;
            background: #ffeaa7;
            border: 2px solid #fdcb6e;
            border-radius: 15px;
            color: #2d3436;
            font-size: 0.7em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .multiplayer-header-btn:hover {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
            transform: scale(1.05);
        }

        .header-mp-dropdown {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
        }

        .header-mp-dropdown.hidden {
            display: none;
        }

        .header-mp-btn {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border: 2px solid #dfe6e9;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-mp-btn:hover {
            background: #ffeaa7;
            border-color: #fdcb6e;
            transform: translateX(5px);
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: white;
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        /* 게임 시작 화면 */
        .game-start-section {
            text-align: center;
            padding: 30px 20px;
        }

        .start-crown {
            font-size: 4em;
            margin-bottom: 10px;
            animation: crownBounce 2s ease-in-out infinite;
        }

        @keyframes crownBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .start-title {
            font-family: 'Do Hyeon', sans-serif;
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #fd79a8;
            text-shadow: 3px 3px 0px rgba(253, 203, 110, 0.5);
        }

        .start-instruction {
            font-family: 'Do Hyeon', sans-serif;
            font-size: 1.3em;
            color: #636e72;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .score-guide {
            background: #fffacd;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 3px solid #ffeaa7;
        }

        .score-guide-compact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .score-item {
            font-size: 1.1em;
            margin: 8px 0;
            color: #2d3436;
            font-weight: bold;
        }

        .special-score {
            font-size: 1em;
            color: #e91e63;
            font-weight: bold;
            margin-top: 12px;
            grid-column: 1 / -1;
            text-align: center;
        }

        .special-score-detail {
            font-size: 0.9em;
            color: #e91e63;
            font-weight: bold;
            grid-column: 1 / -1;
            text-align: center;
        }

        .best-score-display {
            font-size: 1.3em;
            font-weight: bold;
            color: #fd79a8;
            margin-bottom: 25px;
        }

        .game-start-btn {
            padding: 18px 60px;
            font-size: 1.5em;
            font-weight: bold;
            font-family: 'Do Hyeon', sans-serif;
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(253, 121, 168, 0.4);
            transition: all 0.3s ease;
        }

        .game-start-btn:active {
            transform: scale(0.95);
        }

        /* 게임 모드 선택 버튼 */
        .game-mode-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 25px;
        }

        .mode-start-btn {
            padding: 15px 28px;
            font-size: 1.2em;
            font-weight: bold;
            font-family: 'Do Hyeon', sans-serif;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .mode-start-btn.solo {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
        }

        .mode-start-btn.together {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }

        .mode-start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .mode-start-btn:active {
            transform: scale(0.95);
        }

        /* 게임 정보 */
        .game-info {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-box {
            background: #ffeaa7;
            padding: 15px;
            border-radius: 15px;
            flex: 1;
            text-align: center;
            box-shadow: 0 2px 6px rgba(253, 203, 110, 0.3);
        }

        .info-box div:first-child {
            font-size: 0.8em;
            color: #636e72;
            margin-bottom: 5px;
        }

        .info-box div:last-child {
            font-size: 1.5em;
            font-weight: bold;
            color: #2d3436;
        }

        /* 안내 문구 */
        .fixed-guide {
            text-align: center;
            padding: 12px;
            background: #fff5e6;
            border-radius: 20px;
            border: 2px solid #ffeaa7;
            margin-bottom: 15px;
        }

        .fixed-guide-text {
            font-size: 0.9em;
            color: #636e72;
            margin-bottom: 8px;
        }

        .fixed-guide-scores {
            font-size: 0.95em;
            font-weight: bold;
            color: #856404;
        }

        .fixed-guide-special {
            color: #e91e63;
            font-size: 1em;
            font-weight: bold;
            margin-top: 5px;
        }

        /* 초성 */
        .consonants {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: nowrap;
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 20px;
        }

        .consonant {
            font-size: 2.5em;
            font-weight: bold;
            background: white;
            border-radius: 12px;
            padding: 12px 15px;
            min-width: 55px;
            text-align: center;
            animation: float 3s ease-in-out infinite;
            color: #2d3436;
            border: 3px solid #f5f5f5;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .consonant.special {
            background: linear-gradient(135deg, #fab1a0, #e91e63);
            color: white;
            border-color: #e91e63;
        }

        .consonant:nth-child(1) { animation-delay: 0s; }
        .consonant:nth-child(2) { animation-delay: 0.2s; }
        .consonant:nth-child(3) { animation-delay: 0.4s; }
        .consonant:nth-child(4) { animation-delay: 0.6s; }
        .consonant:nth-child(5) { animation-delay: 0.8s; }
        .consonant:nth-child(6) { animation-delay: 1s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes smoothShuffle {
            0% { transform: translateX(0px) rotate(0deg); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            50% { transform: translateX(5px) rotate(2deg); }
            75% { transform: translateX(-3px) rotate(-1deg); }
            100% { transform: translateX(0px) rotate(0deg); }
        }

        .consonants.shuffling .consonant {
            animation: smoothShuffle 0.6s ease-in-out;
        }

        /* 이모티콘 - PC 전용 */
        .emoji-display {
            text-align: center;
            font-size: 4em;
            margin: 15px 0;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .emoji-text {
            font-size: 0.4em;
            font-weight: bold;
            margin-top: 5px;
            color: #2d3436;
        }

        .emoji-score {
            font-size: 0.35em;
            color: #fd79a8;
            font-weight: bold;
            margin-top: 2px;
        }

        /* 점수별 이모티콘 애니메이션 */
        .emoji-score-10 { animation: gentleBounce 2s ease-in-out infinite; }
        .emoji-score-30 { animation: subtlePulse 1.5s ease-in-out infinite; }
        .emoji-score-50 { animation: smartShake 2s ease-in-out infinite; }
        .emoji-score-100 { animation: starJump 1.8s ease-in-out infinite; }
        .emoji-score-400 { animation: fireBlaze 2s ease-in-out infinite; }
        .emoji-score-500 { animation: crownGlow 2.5s ease-in-out infinite; }

        @keyframes gentleBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes subtlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes smartShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }

        @keyframes starJump {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }

        @keyframes fireBlaze {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes crownGlow {
            0%, 100% { 
                transform: scale(1);
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.3);
                filter: brightness(1.5);
            }
        }

        /* 뜻 영역 */
        .definition-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 15px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .definition-text {
            font-size: 1em;
            color: #2d3436;
            line-height: 1.5;
            text-align: center;
        }

        /* 입력창 - PC용 */
        .input-section {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .word-input {
            flex: 1;
            padding: 15px;
            font-size: 1.2em;
            border: 3px solid #fdcb6e;
            border-radius: 15px;
            outline: none;
            text-align: center;
            font-weight: bold;
        }

        .word-input:focus {
            border-color: #fd79a8;
        }

        .submit-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-btn:active {
            transform: scale(0.95);
        }

        .reset-btn {
            background: #ff7675;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 118, 117, 0.4);
            transition: all 0.2s ease;
        }

        .reset-btn:active {
            transform: scale(0.95);
        }

        /* 게임 종료 화면 */
        .game-end-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .game-end-content {
            background: white;
            border-radius: 18px;
            padding: 25px 20px;
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .mascot {
            font-size: 3.5em;
            text-align: center;
            margin: 12px 0;
        }

        .game-end-title {
            font-family: 'Do Hyeon', sans-serif;
            font-size: 1.8em;
            font-weight: bold;
            color: #2d3436;
            text-align: center;
            margin-bottom: 8px;
        }

        .final-score {
            font-size: 2.2em;
            font-weight: bold;
            color: #fd79a8;
            text-align: center;
            margin: 12px 0;
        }

        .game-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 18px 0;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.8em;
            color: #636e72;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2d3436;
        }

        .end-buttons {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .end-btn {
            flex: 1;
            padding: 11px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
        }

        .end-btn.primary {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
        }

        .end-btn.secondary {
            background: #f5f5f5;
            color: #636e72;
        }

        .study-notes {
            margin-top: 20px;
            padding-top: 18px;
            border-top: 2px solid #f0f0f0;
        }

        .study-notes h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #2d3436;
        }

        .word-list {
            display: flex;
            flex-direction: column;
            gap: 7px;
            max-height: 250px;
            overflow-y: auto;
        }

        .word-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #ffeaa7;
        }

        .word-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .word-header strong {
            font-size: 1em;
            color: #2d3436;
        }

        .word-header span {
            font-size: 0.9em;
            font-weight: bold;
            color: #fd79a8;
        }

        .word-def {
            font-size: 0.8em;
            color: #636e72;
            line-height: 1.3;
        }

        /* 토스트 메시지 - PC용 (사용 안함) */
        .toast {
            display: none;
        }

        /* 토스트 메시지 - 모바일용 */
        .toast-message {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(253, 121, 168, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            z-index: 9999;
            text-align: center;
            animation: toastFade 0.8s ease-in-out;
            pointer-events: none;
        }

        @keyframes toastFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .hidden {
            display: none !important;
        }

        /* ===== 멀티플레이 모달 CSS ===== */
        .mp-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .mp-modal-content {
            background: white;
            border-radius: 25px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        }

        .mp-modal-title {
            font-family: 'Do Hyeon', sans-serif;
            font-size: 2em;
            font-weight: bold;
            color: #fd79a8;
            text-align: center;
            margin-bottom: 30px;
        }

        .mp-room-list {
            margin-bottom: 20px;
        }

        .mp-empty-message {
            text-align: center;
            color: #636e72;
            font-size: 1.2em;
            padding: 40px 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .mp-room-item {
            background: #f8f9fa;
            border: 3px solid #dfe6e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .mp-room-item:hover {
            border-color: #fd79a8;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(253, 121, 168, 0.2);
        }

        .mp-room-info {
            flex: 1;
        }

        .mp-room-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 8px;
        }

        .mp-room-players {
            font-size: 0.9em;
            color: #2d3436;
            margin: 5px 0;
            font-weight: normal;
        }

        .mp-room-status {
            font-size: 1em;
            color: #636e72;
        }

        .mp-join-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mp-join-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(9, 132, 227, 0.4);
        }

        .mp-create-solo-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            font-family: 'Do Hyeon', sans-serif;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .mp-create-solo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(253, 121, 168, 0.4);
        }

        .mp-close-btn {
            width: 100%;
            padding: 15px;
            background: #dfe6e9;
            color: #2d3436;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mp-close-btn:hover {
            background: #b2bec3;
        }

        @keyframes mascotSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes mascotJump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        @keyframes mascotPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes mascotShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-7px); }
            75% { transform: translateX(7px); }
        }

        .mascot.mascotSpin { animation: mascotSpin 2s ease-in-out infinite; }
        .mascot.mascotJump { animation: mascotJump 1s ease-in-out infinite; }
        .mascot.mascotPulse { animation: mascotPulse 1.5s ease-in-out infinite; }
        .mascot.mascotShake { animation: mascotShake 0.5s ease-in-out infinite; }

        /* ===== 멀티플레이 좌측 슬롯 + 우측 채팅 ===== */
        
        /* 좌측 슬롯 영역 */
        .player-slots-left {
            position: fixed;
            left: 20px;
            top: 100px;
            width: 220px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
        }

        .player-slots-left.hidden {
            display: none;
        }

        /* 개별 슬롯 */
        .player-slot {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: all 0.3s ease;
            min-height: 100px;
        }

        /* 1등 슬롯 - 화려하게! */
        /* 1등만 특별하게 하지 않고 전부 동일! */
        .player-slot.rank-1 {
            /* rank-1 스타일 제거 - 모두 동일하게 */
        }

        @keyframes rankOnePulse {
            /* 사용 안 함 */
        }

        /* 헤더 (이름 + 상태) */
        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.6);
        }

        .slot-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3436;
        }

        .slot-status {
            font-size: 0.9em;
        }

        /* 슬롯 정보들 */
        .slot-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slot-info-row {
            display: flex;
            align-items: center;
            font-size: 1em;
            color: #2d3436;
        }

        .slot-info-row .icon {
            margin-right: 6px;
        }

        /* 점수 - 더 큼직하게 */
        .slot-score {
            font-size: 2em;
            font-weight: bold;
            color: #2d3436;
        }

        /* 점수 팝업! - 핑크색 + 더 크게! */
        .slot-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.5em;
            font-weight: bold;
            color: #fd79a8;
            text-shadow: 
                3px 3px 6px rgba(0, 0, 0, 0.3),
                0 0 15px rgba(253, 121, 168, 0.8);
            animation: popupBurst 1s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes popupBurst {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.3);
            }
            30% {
                opacity: 1;
                transform: translate(-50%, -70%) scale(1.4);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -110%) scale(1.2);
            }
        }

        /* 빈 슬롯 */
        .player-slot.empty {
            background: #dfe6e9;
            border: 2px solid #b2bec3;
            opacity: 0.7;
        }

        /* 우측 채팅 영역 */
        .chat-container {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 280px;
            height: calc(100vh - 140px);
            max-height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .chat-container.hidden {
            display: none;
        }

        .chat-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #fd79a8;
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffeaa7;
        }

        .chat-hint {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 0.85em;
            color: #856404;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .chat-messages {
            flex: 1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 10px;
            font-size: 0.9em;
            line-height: 1.4;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .chat-message .chat-name {
            font-weight: bold;
            color: #fd79a8;
            margin-right: 5px;
        }

        .chat-message .chat-text {
            color: #2d3436;
        }

        .chat-input-box {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #dfe6e9;
            border-radius: 10px;
            font-size: 0.9em;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: #fd79a8;
        }

        .chat-send-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
        }

        .chat-send-btn:active {
            transform: scale(0.95);
        }

        /* 멀티플레이 결과 모달 */
        .mp-result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .mp-result-content {
            background: white;
            border-radius: 25px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .mp-result-title {
            font-size: 2em;
            font-weight: bold;
            color: #fd79a8;
            text-align: center;
            margin-bottom: 25px;
        }

        .mp-result-player {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .mp-result-player.rank-1 {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e, #ffeaa7);
            border: 3px solid #fd79a8;
            box-shadow: 0 6px 20px rgba(253, 121, 168, 0.4);
        }

        .mp-result-player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .mp-result-player-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3436;
        }

        .mp-result-player-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #2d3436;
        }

        .mp-result-player-stats {
            font-size: 1em;
            color: #636e72;
            margin-bottom: 10px;
        }

        .mp-result-player-words {
            font-size: 0.9em;
            color: #2d3436;
            line-height: 1.5;
        }

        .mp-result-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 25px;
        }
        
        .mp-waiting-message {
            padding: 15px;
            background: #fffacd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            color: #636e72;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
            line-height: 1.5;
        }

        .mp-result-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mp-result-btn.replay {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
        }

        .mp-result-btn.home {
            background: #dfe6e9;
            color: #2d3436;
        }

        .mp-result-btn:hover {
            transform: scale(1.05);
        }

        .mp-result-btn:active {
            transform: scale(0.95);
        }

        /* ===== 모바일 버전 (완전히 다른 디자인) ===== */

        /* 입장 요청 팝업 */
        .join-request-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
        }

        .popup-content h3 {
            margin-bottom: 15px;
            color: #2d3436;
        }

        .popup-content p {
            margin-bottom: 20px;
            color: #636e72;
            line-height: 1.5;
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
        }

        .popup-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .popup-btn.yes {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
        }

        .popup-btn.no {
            background: #dfe6e9;
            color: #636e72;
        }

        .popup-btn:hover {
            transform: scale(1.05);
        }

        /* 구경 모드 화면 */
        .spectate-container {
            text-align: center;
            padding: 40px 20px;
        }

        .spectate-container h2 {
            margin-bottom: 20px;
            color: #2d3436;
        }

        .spectate-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
        }

        .spectate-score, .spectate-time {
            font-size: 1.2em;
            color: #636e72;
        }

        .spectate-score span, .spectate-time span {
            font-size: 1.5em;
            font-weight: bold;
            color: #fd79a8;
        }

        .spectate-consonants {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        /* 대기실 화면 */
        .lobby-container {
            text-align: center;
            padding: 40px 20px;
        }

        .lobby-container h2 {
            margin-bottom: 30px;
            color: #2d3436;
        }

        .player-list {
            max-width: 400px;
            margin: 0 auto 30px;
        }

        .player-item {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #dfe6e9;
            font-size: 1.1em;
        }

        .player-item.me {
            background: #ffeaa7;
            border-color: #fdcb6e;
            font-weight: bold;
        }

        .start-game-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-game-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(253, 121, 168, 0.3);
        }

        /* 알림 토스트 */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fd79a8;
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 기다리기 버튼 스타일 */
        #acceptingBtn {
            transition: all 0.3s ease;
        }
        @media (max-width: 768px) {
            body {
                padding: 0;
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }

            .header {
                display: none;
            }

            .container {
                border-radius: 0;
                padding: 0;
                max-width: 100%;
                height: 100vh;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                position: relative;
                z-index: 1;
                background: rgba(255, 255, 255, 0.95);
            }

            .game-start-section {
                flex: 1;
                overflow-y: auto;
                padding: 30px 20px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .start-title {
                font-size: 2.5em;
            }

            .start-instruction {
                font-size: 1.1em;
                margin-bottom: 25px;
            }

            .score-guide {
                padding: 15px;
                margin-bottom: 20px;
            }

            .score-guide-compact {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 10px;
            }

            .score-item {
                font-size: 1em;
                margin: 5px 0;
            }

            .special-score {
                font-size: 0.9em;
                margin-top: 8px;
            }

            .special-score-detail {
                font-size: 0.8em;
            }

            .game-start-btn {
                padding: 15px 40px;
                font-size: 1.3em;
                margin-top: 10px;
            }

            /* 게임 화면 - 모바일 */
            #gameScreen {
                display: flex;
                flex-direction: column;
                height: 100%;
                overflow: hidden;
            }

            /* 1줄: 점수/시간/최고 + 새게임 */
            .game-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 3px;
                padding: 6px 8px;
                margin: 0;
                background: white;
                border-bottom: 1px solid #f0f0f0;
                flex-shrink: 0;
            }

            .info-box {
                background: #ffeaa7;
                padding: 6px 8px;
                border-radius: 8px;
                flex: 1;
                text-align: center;
                box-shadow: 0 1px 3px rgba(253, 203, 110, 0.3);
            }

            .info-box div:first-child {
                font-size: 0.55em;
                color: #636e72;
                margin-bottom: 2px;
            }

            .info-box div:last-child {
                font-size: 0.9em;
                font-weight: bold;
                color: #2d3436;
            }

            .reset-btn {
                padding: 6px 10px;
                font-size: 0.9em;
                border-radius: 8px;
                min-width: 60px;
            }

            .settings-btn {
                padding: 6px 10px;
                font-size: 1.2em;
                margin: 0;
                border-radius: 8px;
                min-width: 40px;
                background: #f5f5f5;
                border: 2px solid #dfe6e9;
                color: #636e72;
                cursor: pointer;
            }

            /* 2줄: 안내 문구 숨김 */
            .fixed-guide {
                display: none;
            }

            /* 3줄: 초성 */
            .consonants {
                display: flex;
                justify-content: center;
                gap: 3px;
                margin: 0;
                padding: 10px 8px;
                background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
                border-radius: 0;
                flex-shrink: 0;
            }

            .consonant {
                font-size: 1.5em;
                padding: 6px 10px;
                min-width: 36px;
                border: 2px solid #f5f5f5;
            }

            /* 4줄: 이모티콘 숨김 (토스트로 대체) */
            .emoji-display {
                display: none;
            }

            /* 5줄: 뜻 - 2줄 고정으로 수정 */
            .definition-container {
                background: #f8f9fa;
                padding: 10px 12px;
                border-radius: 0;
                margin: 0;
                height: 48px;
                min-height: 48px;
                max-height: 48px;
                flex-shrink: 0;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }

            .definition-text {
                font-size: 0.9em;
                color: #2d3436;
                line-height: 1.3;
                text-align: center;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
                max-height: 2.6em;
                width: 100%;
            }

            /* 6줄: 입력창 - 흰배경 노란테두리 */
            .input-section {
                display: flex;
                gap: 8px;
                padding: 10px 12px;
                margin: 0;
                background: white;
                border-top: 1px solid #f0f0f0;
                flex-shrink: 0;
            }

            .word-input {
                flex: 1;
                padding: 10px 12px;
                font-size: 1.1em;
                border: 3px solid #fdcb6e;
                border-radius: 12px;
                background: white;
                color: #2d3436;
                text-align: center;
                font-weight: bold;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            }

            .word-input::placeholder {
                color: #b2bec3;
            }

            .word-input:focus {
                border-color: #fd79a8;
            }

            .submit-btn {
                padding: 10px 20px;
                font-size: 1em;
                border-radius: 12px;
            }

            /* 나머지 공간 - 여백 없이 */
            .game-content {
                flex: 1;
                min-height: 0;
                overflow: hidden;
            }

            /* 별똥별 배경 컨테이너 - 모바일 전용 */
            .falling-bg {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 35vh;
                background: linear-gradient(to bottom, rgba(255, 255, 255, 0.95), rgba(255, 234, 167, 0.95));
                z-index: 1;
                pointer-events: none;
                overflow: hidden;
            }

            /* 별똥별 초성 */
            .consonant-star {
                position: absolute;
                font-size: 24px;
                font-weight: bold;
                color: rgba(93, 64, 55, 0.25);
                animation: fall linear infinite;
                opacity: 0;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                pointer-events: none;
            }

            .consonant-star.special { 
                color: rgba(233, 30, 99, 0.3); 
            }

            @keyframes fall {
                0% {
                    transform: translateY(-50px) rotate(0deg) scale(0.8);
                    opacity: 0;
                }
                10% {
                    opacity: 0.5;
                    transform: translateY(0) rotate(180deg) scale(1);
                }
                90% {
                    opacity: 0.3;
                }
                100% {
                    transform: translateY(35vh) rotate(360deg) scale(0.6);
                    opacity: 0;
                }
            }


            /* 설정 모달 */
            .settings-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .settings-content {
                background: white;
                border-radius: 20px;
                padding: 25px;
                width: 80%;
                max-width: 300px;
            }

            .settings-title {
                font-size: 1.3em;
                font-weight: bold;
                margin-bottom: 20px;
                text-align: center;
                color: #2d3436;
            }

            .settings-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px solid #f0f0f0;
            }

            .settings-item:last-of-type {
                border-bottom: none;
            }

            .settings-label {
                font-size: 1em;
                color: #2d3436;
            }

            .settings-toggle {
                padding: 6px 15px;
                border-radius: 12px;
                border: 2px solid #dfe6e9;
                background: #f5f5f5;
                color: #636e72;
                font-size: 0.9em;
                font-weight: bold;
                cursor: pointer;
            }

            .settings-toggle.active {
                background: #ffeaa7;
                border-color: #fdcb6e;
                color: #2d3436;
            }

            .settings-newgame-btn {
                width: 100%;
                padding: 12px;
                margin-top: 10px;
                background: #ff7675;
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 1em;
                font-weight: bold;
                cursor: pointer;
            }

            .settings-close-btn {
                width: 100%;
                padding: 12px;
                margin-top: 10px;
                background: linear-gradient(135deg, #fd79a8, #fdcb6e);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 1em;
                font-weight: bold;
                cursor: pointer;
            }

            /* 게임 종료 화면에서만 스크롤 허용 */
            .game-end-overlay {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .game-end-content {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        /* ===== 멀티플레이어 CSS (PC 전용) ===== */
        .multiplayer-section {
            margin: 20px 0;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            font-family: 'Do Hyeon', sans-serif;
            border: 3px solid #dfe6e9;
            border-radius: 15px;
            background: white;
            color: #636e72;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            border-color: #fd79a8;
            transform: scale(1.02);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
            border-color: #fd79a8;
        }

        .multiplayer-dropdown {
            margin: 15px 0;
        }

        .dropdown-btn {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            font-weight: bold;
            background: #f8f9fa;
            border: 2px solid #dfe6e9;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dropdown-btn:hover {
            background: #ffeaa7;
            border-color: #fdcb6e;
        }

        .dropdown-content {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #dfe6e9;
        }

        .dropdown-content.hidden {
            display: none;
        }

        .mp-btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            font-size: 1em;
            font-weight: bold;
            background: white;
            border: 2px solid #dfe6e9;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mp-btn:hover {
            background: #ffeaa7;
            border-color: #fdcb6e;
            transform: translateX(5px);
        }

        /* 방 목록 모달 */
        .room-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .room-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .room-modal-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #2d3436;
        }

        .room-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            border: 2px solid #dfe6e9;
        }

        .room-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #fd79a8;
            margin-bottom: 10px;
        }

        .room-players {
            font-size: 0.9em;
            color: #636e72;
            margin: 5px 0;
        }

        .room-join-btn {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        .room-create-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .room-create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(9, 132, 227, 0.4);
        }

        .room-close-btn {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: #636e72;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        /* 대기방 화면 */
        .waiting-room {
            text-align: center;
            padding: 20px;
        }

        .waiting-room-code {
            font-size: 2em;
            font-weight: bold;
            color: #fd79a8;
            margin: 20px 0;
        }

        .copy-code-btn {
            padding: 10px 20px;
            background: #ffeaa7;
            border: 2px solid #fdcb6e;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
        }

        .player-list {
            margin: 20px 0;
            text-align: left;
        }

        .player-slot {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #dfe6e9;
        }

        .player-slot.empty {
            opacity: 0.5;
            border-style: dashed;
        }

        /* 멀티플레이어 게임 화면 (2x2 그리드) */
        .mp-game-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: 100%;
        }

        .mp-player-screen {
            background: white;
            border-radius: 15px;
            padding: 15px;
            border: 3px solid #dfe6e9;
            display: flex;
            flex-direction: column;
        }

        .mp-player-screen.me {
            border-color: #fd79a8;
            box-shadow: 0 0 20px rgba(253, 121, 168, 0.3);
        }

        .mp-player-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .mp-player-name {
            font-weight: bold;
            color: #2d3436;
        }

        .mp-player-score {
            font-weight: bold;
            color: #fd79a8;
        }

        .mp-consonants-mini {
            display: flex;
            gap: 3px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .mp-consonant-mini {
            font-size: 0.9em;
            padding: 4px 8px;
            background: #ffeaa7;
            border-radius: 8px;
            font-weight: bold;
        }

        .mp-last-word {
            text-align: center;
            font-size: 1.2em;
            color: #636e72;
            margin: 10px 0;
        }

        /* 모바일에서는 멀티플레이어 숨김 */
        @media (max-width: 768px) {
            .multiplayer-section {
                display: none !important;
            }
            
            .mode-start-btn.together {
                display: none !important;
            }
        }

        /* ===== 멀티플레이어 슬롯 레이아웃 ===== */
        .mp-slots-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 10;
        }

        .mp-player-slot {
            position: absolute;
            width: 220px;
            min-height: 180px;
            padding: 15px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            pointer-events: auto;
        }

        /* 슬롯 위치 */
        .mp-player-slot.slot-1 {
            top: 80px;
            left: 20px;
        }

        .mp-player-slot.slot-2 {
            top: 80px;
            right: 20px;
        }

        .mp-player-slot.slot-3 {
            bottom: 20px;
            left: 20px;
        }

        .mp-player-slot.slot-4 {
            bottom: 20px;
            right: 20px;
        }

        .mp-player-slot.empty {
            opacity: 0.3;
            background: #f8f9fa;
        }

        .mp-slot-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffeaa7;
        }

        .mp-slot-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #2d3436;
        }

        .mp-slot-chat {
            max-height: 60px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .mp-chat-message {
            font-size: 0.9em;
            color: #636e72;
            margin: 3px 0;
            padding: 5px 8px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .mp-slot-score {
            font-size: 1.3em;
            font-weight: bold;
            color: #fd79a8;
            margin-bottom: 5px;
        }

        .mp-score-popup {
            font-size: 1.5em;
            font-weight: bold;
            animation: scorePopup 0.8s ease-out;
        }

        .mp-score-popup.positive {
            color: #00b894;
        }

        @keyframes scorePopup {
            0% {
                transform: scale(0) translateY(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) translateY(-10px);
                opacity: 1;
            }
            100% {
                transform: scale(1) translateY(-20px);
                opacity: 0;
            }
        }

        /* 대기실 채팅 */
        .mp-waiting-chat {
            margin-top: 15px;
            padding: 10px;
            background: #fffacd;
            border-radius: 12px;
        }

        .mp-chat-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #fdcb6e;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 8px;
        }

        .mp-chat-messages {
            max-height: 100px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .mp-chat-item {
            font-size: 0.9em;
            margin: 5px 0;
            color: #2d3436;
        }

        .mp-chat-name {
            font-weight: bold;
            color: #fd79a8;
        }
    </style>
</head>
<body>
    <!-- 멀티플레이어 슬롯 -->
    <div id="mpSlotsContainer" class="mp-slots-container hidden">
        <div id="mpSlot1" class="mp-player-slot slot-1 empty">
            <div class="mp-slot-header">
                <span class="mp-slot-name">플레이어1</span>
            </div>
            <div class="mp-slot-chat"></div>
            <div class="mp-slot-score">0점</div>
            <div class="mp-score-popup-container"></div>
        </div>
        
        <div id="mpSlot2" class="mp-player-slot slot-2 empty">
            <div class="mp-slot-header">
                <span class="mp-slot-name">플레이어2</span>
            </div>
            <div class="mp-slot-chat"></div>
            <div class="mp-slot-score">0점</div>
            <div class="mp-score-popup-container"></div>
        </div>
        
        <div id="mpSlot3" class="mp-player-slot slot-3 empty">
            <div class="mp-slot-header">
                <span class="mp-slot-name">플레이어3</span>
            </div>
            <div class="mp-slot-chat"></div>
            <div class="mp-slot-score">0점</div>
            <div class="mp-score-popup-container"></div>
        </div>
        
        <div id="mpSlot4" class="mp-player-slot slot-4 empty">
            <div class="mp-slot-header">
                <span class="mp-slot-name">플레이어4</span>
            </div>
            <div class="mp-slot-chat"></div>
            <div class="mp-slot-score">0점</div>
            <div class="mp-score-popup-container"></div>
        </div>
    </div>

    <div class="header">
        <div class="logo">
            🎮 초성왕
        </div>
        <div class="audio-controls">
            <button id="bgmBtn" class="audio-btn active" onclick="toggleBGM()">🎵 BGM</button>
            <button id="sfxBtn" class="audio-btn active" onclick="toggleSFX()">🔊 효과음</button>
            <button id="typingBtn" class="audio-btn active" onclick="toggleTyping()">⌨️ 타건음</button>
        </div>
    </div>


    <div class="container">
        <!-- 게임 시작 화면 -->
        <div id="gameStartSection" class="game-start-section">
            <div class="start-crown">👑</div>
            <div class="start-title">초성왕</div>
            
            <div class="start-instruction">
                제시된 초성으로 순서 상관없이<br>맘껏 단어를 만드세요!
            </div>

            <div class="score-guide">
                <div class="score-guide-compact">
                    <div class="score-item">2글자: 10점</div>
                    <div class="score-item">3글자: 100점</div>
                    <div class="score-item">4글자: 400점</div>
                    <div class="score-item">5글자: 900점</div>
                    <div class="special-score">✨ 특별초성(ㄲㄸㅃㅆㅉㅊㅋㅌㅍ)</div>
                    <div class="special-score-detail">각 +20점</div>
                </div>
            </div>

            <div class="best-score-display" id="bestScoreDisplay">
                🏆 최고 기록: 0점
            </div>


            <!-- 게임 모드 선택 버튼 -->
            <div class="game-mode-buttons" id="gameModeButtons">
                <!-- JavaScript로 동적 생성 -->
            </div>

            <!-- 대기실 채팅 (멀티플레이 시에만 표시) -->
            <div id="mpWaitingChat" class="mp-waiting-chat hidden">
                <div class="mp-chat-messages" id="mpChatMessages">
                    <!-- 채팅 메시지 -->
                </div>
                <input type="text" id="mpChatInput" class="mp-chat-input" placeholder="채팅을 입력하세요..." autocomplete="off">
            </div>
        </div>

        <!-- 게임 화면 -->
        <div id="gameScreen" class="hidden">
            <!-- 게임 정보 -->
            <div class="game-info">
                <div class="info-box">
                    <div>점수</div>
                    <div id="score">0</div>
                </div>
                <div class="info-box">
                    <div>남은 시간</div>
                    <div id="timer">180</div>
                </div>
                <div class="info-box">
                    <div>최고 기록</div>
                    <div id="currentBestScore">0</div>
                </div>
                <button class="reset-btn" onclick="resetGame()">🔄 새게임</button>
                <button id="mpLeaveBtn" class="reset-btn hidden" onclick="leaveGameRoom()" style="background: #ff7675;">🚪 나가기</button>
                <button class="settings-btn hidden" onclick="openSettings()">⚙️</button>
            </div>

            <!-- 안내 문구 (PC only) -->
            <div class="fixed-guide">
                <div class="fixed-guide-text">제시된 초성으로 순서 상관없이 단어를 만드세요!</div>
                <div class="fixed-guide-scores">2글자 10점 / 3글자 100점 / 4글자 400점 / 5글자 900점 / 6글자 1500점</div>
                <div class="fixed-guide-special">특별초성(ㄲㄸㅃㅆㅉㅊㅋㅌㅍ) 각 +20점</div>
            </div>

            <!-- 초성 -->
            <div class="consonants" id="consonants"></div>

            <!-- 이모티콘 (PC only) -->
            <div class="emoji-display" id="emojiDisplay">
                <div>🤔</div>
                <div class="emoji-text">단어를 입력해주세요</div>
                <div class="emoji-score">+0점</div>
            </div>

            <!-- 뜻 -->
            <div class="definition-container">
                <div class="definition-text" id="definitionText">단어를 입력하면 뜻이 표시됩니다</div>
            </div>

            <!-- 입력창 -->
            <div class="input-section">
                <input type="text" id="wordInput" class="word-input" placeholder="단어 입력" autocomplete="off">
                <button class="submit-btn" onclick="checkWord()">확인</button>
            </div>

            <!-- 나머지 공간 -->
            <div class="game-content"></div>
        </div>
    </div>

    <!-- 설정 모달 (모바일 전용) -->
    <div id="settingsModal" class="settings-modal hidden">
        <div class="settings-content">
            <div class="settings-title">⚙️ 설정</div>
            <div class="settings-item">
                <div class="settings-label">🎵 BGM</div>
                <button id="modalBgmBtn" class="settings-toggle active" onclick="toggleModalBGM()">ON</button>
            </div>
            <div class="settings-item">
                <div class="settings-label">🔊 효과음</div>
                <button id="modalSfxBtn" class="settings-toggle active" onclick="toggleModalSFX()">ON</button>
            </div>
            <div class="settings-item">
                <div class="settings-label">⌨️ 타건음</div>
                <button id="modalTypingBtn" class="settings-toggle active" onclick="toggleModalTyping()">ON</button>
            </div>
            <button class="settings-newgame-btn" onclick="resetGameFromSettings()">🔄 새게임</button>
            <button class="settings-close-btn" onclick="closeSettings()">닫기</button>
        </div>
    </div>

    <!-- 멀티플레이 대기방 목록 모달 -->
    <div id="mpRoomModal" class="mp-modal-overlay hidden">
        <div class="mp-modal-content">
            <div class="mp-modal-title">👥 대기방 목록</div>
            <div id="mpRoomList" class="mp-room-list">
                <!-- 동적으로 생성됨 -->
            </div>
            <button class="mp-create-solo-btn" onclick="createAndStartSoloWaiting()">
                🎮 혼자 놀면서 기다리기
            </button>
            <button class="mp-close-btn" onclick="closeRoomModal()">닫기</button>
        </div>
    </div>

    <!-- 이름 입력 모달 -->
    <div id="mpNameModal" class="mp-modal-overlay hidden">
        <div class="mp-name-modal">
            <div class="mp-name-title">이름을 입력하세요</div>
            <input type="text" id="mpNameInput" class="mp-name-input" placeholder="이름" maxlength="10">
            <div class="mp-name-buttons">
                <button class="mp-name-confirm" onclick="confirmName()">확인</button>
                <button class="mp-name-cancel" onclick="cancelName()">취소</button>
            </div>
        </div>
    </div>

    <!-- 멀티플레이: 좌측 슬롯 -->
    <div id="playerSlotsLeft" class="player-slots-left hidden">
        <!-- 슬롯 4개 동적 생성 -->
    </div>

    <!-- 멀티플레이: 우측 채팅 -->
    <div id="chatContainer" class="chat-container hidden">
        <div class="chat-title">💬 채팅</div>
        <div class="chat-hint">
            ⚠️ 게임 중 <strong>/</strong>를 누르면<br>
            채팅이 가능해요
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- 채팅 메시지 동적 생성 -->
        </div>
        <div class="chat-input-box">
            <input 
                type="text" 
                id="chatInput" 
                class="chat-input" 
                placeholder="메시지 입력..."
                maxlength="100"
                disabled
            />
            <button class="chat-send-btn" onclick="sendChatMessage()">전송</button>
        </div>
    </div>

    <audio id="tickSound" src="./tick.mp3"></audio>

    <script>
        // 게임 상태
        const gameState = {
            score: 0,
            timeLeft: 180,
            usedWords: [],
            wordDefinitions: {},
            currentConsonants: [],
            originalConsonants: [],
            gameRunning: false,
            gameTimer: null,
            bgmEnabled: true,
            sfxEnabled: true,
            typingEnabled: true,
            tickSoundPlaying: false,
            bestScore: 0,
            roundCount: 0,
            shuffleCount: 0,
            isMobile: window.innerWidth <= 768
        };

        // 초성 목록
        const CONSONANTS = ['ㄱ', 'ㄴ', 'ㄷ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅅ', 'ㅇ', 'ㅈ', 'ㅎ'];
        const SPECIAL_CONSONANTS = ['ㄲ', 'ㄸ', 'ㅃ', 'ㅆ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ'];

        function getRandomConsonants() {
            const count = 6; // 6개로 고정
            const specialCount = Math.random() < 0.5 ? 1 : 2; // 1개 또는 2개
            const consonants = [];

            // 특별 초성 추가 (중복 없음)
            const usedSpecials = [];
            for (let i = 0; i < specialCount; i++) {
                let special;
                do {
                    special = SPECIAL_CONSONANTS[Math.floor(Math.random() * SPECIAL_CONSONANTS.length)];
                } while (usedSpecials.includes(special));
                usedSpecials.push(special);
                consonants.push({ char: special, isSpecial: true });
            }

            // 일반 초성 추가
            const normalCount = count - specialCount;
            const normalConsonants = [];
            
            // 중복 여부 결정 (33% 확률로 중복, 67% 확률로 중복 없음)
            const shouldDuplicate = Math.random() < 0.33 && normalCount >= 2;
            
            if (shouldDuplicate) {
                // 중복할 문자 선택
                const duplicateChar = CONSONANTS[Math.floor(Math.random() * CONSONANTS.length)];
                normalConsonants.push(duplicateChar, duplicateChar);
                
                // 나머지 일반 초성 추가 (중복 없음)
                const remainingCount = normalCount - 2;
                for (let i = 0; i < remainingCount; i++) {
                    let normal;
                    do {
                        normal = CONSONANTS[Math.floor(Math.random() * CONSONANTS.length)];
                    } while (normal === duplicateChar || normalConsonants.includes(normal));
                    normalConsonants.push(normal);
                }
            } else {
                // 중복 없이 일반 초성 추가
                for (let i = 0; i < normalCount; i++) {
                    let normal;
                    do {
                        normal = CONSONANTS[Math.floor(Math.random() * CONSONANTS.length)];
                    } while (normalConsonants.includes(normal));
                    normalConsonants.push(normal);
                }
            }

            // 일반 초성을 consonants 배열에 추가
            normalConsonants.forEach(normal => {
                consonants.push({ char: normal, isSpecial: false });
            });

            return consonants.sort(() => Math.random() - 0.5);
        }

        function hasEnoughConsonants(wordChosung, currentChars) {
            const availableChars = [...currentChars];
            for (const ch of wordChosung) {
                const index = availableChars.indexOf(ch);
                if (index === -1) return false;
                availableChars.splice(index, 1);
            }
            return true;
        }

        function displayConsonants(consonants) {
            const container = document.getElementById('consonants');
            container.innerHTML = consonants.map(c => 
                `<div class="consonant ${c.isSpecial ? 'special' : ''}">${c.char}</div>`
            ).join('');
        }

        function shuffleConsonants(type) {
            const container = document.getElementById('consonants');
            if (type === 'reverse') {
                gameState.currentConsonants.reverse();
            } else {
                gameState.currentConsonants = [...gameState.currentConsonants].sort(() => Math.random() - 0.5);
            }
            container.classList.add('shuffling');
            displayConsonants(gameState.currentConsonants);
            setTimeout(() => container.classList.remove('shuffling'), 600);
            gameState.shuffleCount++;
        }

        function getChosung(str) {
            const chosungList = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
            const result = [];
            for (let i = 0; i < str.length; i++) {
                const code = str.charCodeAt(i) - 44032;
                if (code > -1 && code < 11172) {
                    result.push(chosungList[Math.floor(code / 588)]);
                }
            }
            return result;
        }

        function calculateScore(word, inputChosung) {
            let baseScore = 0;
            if (word.length === 2) baseScore = 10;
            else if (word.length === 3) baseScore = 100;
            else if (word.length === 4) baseScore = 400;
            else if (word.length === 5) baseScore = 900;
            else if (word.length >= 6) baseScore = 1500;
            
            let bonusScore = 0;
            inputChosung.forEach(ch => {
                const found = gameState.currentConsonants.find(c => c.char === ch);
                if (found && found.isSpecial) bonusScore += 20;
            });

            return { base: baseScore, bonus: bonusScore, total: baseScore + bonusScore };
        }

        function updateEmoji(emoji, message, score) {
            if (gameState.isMobile) return; // 모바일에서는 이모티콘 표시 안함
            
            const emojiDisplay = document.getElementById('emojiDisplay');
            emojiDisplay.innerHTML = `
                <div>${emoji}</div>
                <div class="emoji-text">${message}</div>
                <div class="emoji-score">+${score}점</div>
            `;
            
            // 모든 애니메이션 클래스 제거
            emojiDisplay.classList.remove('emoji-score-10', 'emoji-score-30', 'emoji-score-50', 
                                        'emoji-score-100', 'emoji-score-400', 'emoji-score-500');
            
            // 점수별 애니메이션 클래스 추가
            if (score >= 500) {
                emojiDisplay.classList.add('emoji-score-500');
            } else if (score >= 400) {
                emojiDisplay.classList.add('emoji-score-400');
            } else if (score >= 100) {
                emojiDisplay.classList.add('emoji-score-100');
            } else if (score >= 50) {
                emojiDisplay.classList.add('emoji-score-50');
            } else if (score >= 30) {
                emojiDisplay.classList.add('emoji-score-30');
            } else {
                emojiDisplay.classList.add('emoji-score-10');
            }
        }

        function updateDefinition(definition) {
            document.getElementById('definitionText').textContent = definition;
        }

        function showToast(emoji, message, score) {
            if (!gameState.isMobile) return; // PC에서는 토스트 안띄움
            
            // 이전 토스트 제거
            const oldToast = document.querySelector('.toast-message');
            if (oldToast) oldToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.innerHTML = `<div class="toast-text">${emoji} ${message}</div><div class="toast-score">+${score}점</div>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 800);
        }

        // 별똥별 초성 배경 생성 함수
        function createFallingConsonants() {
            // 기존 컨테이너와 별똥별 제거
            const oldContainer = document.querySelector('.falling-bg');
            if (oldContainer) oldContainer.remove();
            
            // 모바일에서만 생성
            if (!gameState.isMobile) return;
            
            // 별똥별 배경 컨테이너 생성
            const container = document.createElement('div');
            container.className = 'falling-bg';
            document.body.appendChild(container);
            
            const consonants = ['ㄱ', 'ㄴ', 'ㄷ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅅ', 'ㅇ', 'ㅈ', 'ㅎ'];
            const specialConsonants = ['ㄲ', 'ㄸ', 'ㅃ', 'ㅆ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ'];
            
            // 일반 초성 12개
            for (let i = 0; i < 12; i++) {
                const star = document.createElement('div');
                star.className = 'consonant-star';
                star.textContent = consonants[Math.floor(Math.random() * consonants.length)];
                star.style.left = Math.random() * 100 + '%';
                star.style.animationDuration = (8 + Math.random() * 10) + 's';
                star.style.animationDelay = (Math.random() * 8) + 's';
                container.appendChild(star);
            }
            
            // 특수 초성 4개
            for (let i = 0; i < 4; i++) {
                const star = document.createElement('div');
                star.className = 'consonant-star special';
                star.textContent = specialConsonants[Math.floor(Math.random() * specialConsonants.length)];
                star.style.left = Math.random() * 100 + '%';
                star.style.animationDuration = (10 + Math.random() * 8) + 's';
                star.style.animationDelay = (Math.random() * 6) + 's';
                container.appendChild(star);
            }
        }

        async function checkWord() {
            const input = document.getElementById('wordInput');
            const word = input.value.trim();
            if (!word) return;

            // "/" 로 시작하면 채팅 메시지
            if (multiplayerState.isMultiplayer && word.startsWith('/')) {
                const chatMessage = word.substring(1).trim(); // "/" 제거
                if (chatMessage) {
                    addChatMessage(multiplayerState.playerName, chatMessage);
                }
                input.value = '';
                return;
            }

            const wordChosung = getChosung(word);
            const currentChars = gameState.currentConsonants.map(c => c.char);

            if (word.length < 2 || word.length > 6) {
                if (gameState.isMobile) {
                    showToast('😓', '2~6글자만 가능해요', 0);
                } else {
                    updateEmoji('😓', '2~6글자만 가능해요', 0);
                }
                playWrongSound();
                input.value = '';
                return;
            }

            const isValid = hasEnoughConsonants(wordChosung, currentChars);
            if (!isValid) {
                if (gameState.isMobile) {
                    showToast('😓', '초성을 확인해주세요', 0);
                } else {
                    updateEmoji('😓', '초성을 확인해주세요', 0);
                }
                playWrongSound();
                input.value = '';
                return;
            }

            if (gameState.usedWords.includes(word)) {
                if (gameState.isMobile) {
                    showToast('😓', '이미 사용한 단어예요', 0);
                } else {
                    updateEmoji('😓', '이미 사용한 단어예요', 0);
                }
                playWrongSound();
                input.value = '';
                return;
            }

            try {
                const response = await fetch('/api/validate-word', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ word })
                });
                const data = await response.json();

                if (data.valid) {
                    const score = calculateScore(word, wordChosung);
                    gameState.score += score.total;
                    gameState.usedWords.push(word);

                    const definition = data.definitions && data.definitions[0] ? data.definitions[0].definition : '뜻을 불러올 수 없습니다';
                    gameState.wordDefinitions[word] = definition;

                    document.getElementById('score').textContent = gameState.score;
                    updateDefinition(definition);

                    let message = '';
                    let emoji = '';
                    if (score.total >= 500) {
                        emoji = '👑';
                        message = '레전드다!';
                    } else if (score.total >= 400) {
                        emoji = '🔥';
                        message = '초성 천재!';
                    } else if (score.total >= 100) {
                        emoji = '🤩';
                        message = '대박 사건!';
                    } else if (score.total >= 50) {
                        emoji = '🤓';
                        message = '대단해요!';
                    } else if (score.total >= 30) {
                        emoji = '😉';
                        message = '제법인데?';
                    } else {
                        emoji = '🤨';
                        message = '기본이지!';
                    }
                    
                    if (gameState.isMobile) {
                        showToast(emoji, message, score.total);
                    } else {
                        updateEmoji(emoji, message, score.total);
                    }
                    playScoreSound(score.total);

                    input.value = '';
                    input.focus();
                } else {
                    if (gameState.isMobile) {
                        showToast('😓', '올바른 단어가 아니에요', 0);
                    } else {
                        updateEmoji('😓', '올바른 단어가 아니에요', 0);
                    }
                    playWrongSound();
                    input.value = '';
                }
            } catch (error) {
                if (gameState.isMobile) {
                    showToast('😓', '오류가 발생했어요', 0);
                } else {
                    updateEmoji('😓', '오류가 발생했어요', 0);
                }
                playWrongSound();
                input.value = '';
            }
        }

        function startGame() {
            gameState.score = 0;
            gameState.timeLeft = 180;
            gameState.usedWords = [];
            gameState.wordDefinitions = {};
            gameState.gameRunning = true;
            gameState.tickSoundPlaying = false;
            gameState.roundCount++;
            gameState.shuffleCount = 0;
            
            gameState.originalConsonants = getRandomConsonants();
            gameState.currentConsonants = [...gameState.originalConsonants];
            
            displayConsonants(gameState.currentConsonants);
            
            document.getElementById('gameStartSection').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            document.getElementById('score').textContent = 0;
            document.getElementById('timer').textContent = 180;
            
            if (gameState.isMobile) {
                updateDefinition('단어를 입력하면 뜻이 표시됩니다');
                // 모바일에서만 별똥별 초성 배경 생성
                createFallingConsonants();
            } else {
                updateEmoji('🤔', '단어를 입력해주세요', 0);
                updateDefinition('단어를 입력하면 뜻이 표시됩니다');
            }
            
            const input = document.getElementById('wordInput');
            input.value = '';
            setTimeout(() => input.focus(), 300);
            
            document.body.classList.remove('time-warning');
            
            gameState.gameTimer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft === 120 && gameState.shuffleCount === 0) {
                    shuffleConsonants('reverse');
                } else if (gameState.timeLeft === 60 && gameState.shuffleCount === 1) {
                    shuffleConsonants('random');
                }
                
                if (gameState.timeLeft === 10) {
                    document.body.classList.add('time-warning');
                    if (gameState.sfxEnabled) playTickSound();
                    if (bgmAudio && gameState.bgmEnabled) fadeOutBGM();
                }
                
                if (gameState.timeLeft <= 0) endGame();
            }, 1000);
            
            if (gameState.bgmEnabled) playBGM();
        }

        function endGame() {
            clearInterval(gameState.gameTimer);
            gameState.gameRunning = false;
            document.body.classList.remove('time-warning');
            
            // 모바일에서 키보드 내리기
            const input = document.getElementById('wordInput');
            if (input) input.blur();
            
            stopTickSound();
            stopBGM();
            saveBestScore(gameState.score);

            if (gameState.sfxEnabled) {
                try {
                    const audio = new Audio('./finished.mp3');
                    audio.volume = 0.5;
                    audio.play().catch(e => {});
                } catch (e) {}
            }

            showGameEndScreen();
        }

        function getGameEndMessage(score) {
            if (score >= 2000) return { emoji: '👑', message: '초성의 전설!!!', animation: 'mascotSpin' };
            else if (score >= 1501) return { emoji: '🔥', message: '당신은 초성왕!', animation: 'mascotJump' };
            else if (score >= 1001) return { emoji: '🤩', message: '고수시네요?', animation: 'mascotPulse' };
            else if (score >= 601) return { emoji: '🤓', message: '제법인데요?', animation: 'mascotShake' };
            else if (score >= 301) return { emoji: '😉', message: '기본은 하시네요?', animation: 'mascotPulse' };
            else return { emoji: '🤨', message: '할많하않...', animation: 'mascotShake' };
        }

        function showGameEndScreen() {
            const endData = getGameEndMessage(gameState.score);
            const overlay = document.createElement('div');
            overlay.className = 'game-end-overlay';
            overlay.innerHTML = `
                <div class="game-end-content">
                    <div class="mascot ${endData.animation}">${endData.emoji}</div>
                    <div class="game-end-title">${endData.message}</div>
                    <div class="final-score">${gameState.score}점</div>
                    <div class="game-stats">
                        <div class="stat-box">
                            <div class="stat-label">맞춘 단어</div>
                            <div class="stat-value">${gameState.usedWords.length}개</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">최고 기록</div>
                            <div class="stat-value">${gameState.bestScore}점</div>
                        </div>
                    </div>
                    <div class="study-notes">
                        <h3>📚 학습 노트</h3>
                        <div id="studyWordList" class="word-list"></div>
                    </div>
                    <div class="end-buttons">
                        <button class="end-btn secondary" onclick="closeGameEndScreen()">닫기</button>
                        <button class="end-btn primary" onclick="closeGameEndScreen(); setTimeout(startGame, 100);">다시 하기</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            const studyList = overlay.querySelector('#studyWordList');
            gameState.usedWords.forEach(word => {
                const definition = gameState.wordDefinitions[word] || '뜻풀이를 불러오지 못했습니다.';
                const score = calculateScore(word, getChosung(word));
                const wordItem = document.createElement('div');
                wordItem.className = 'word-item';
                wordItem.innerHTML = `
                    <div class="word-header">
                        <strong>${word}</strong>
                        <span>+${score.total}점</span>
                    </div>
                    <div class="word-def">${definition}</div>
                `;
                studyList.appendChild(wordItem);
            });
        }

        function closeGameEndScreen() {
            const overlay = document.querySelector('.game-end-overlay');
            if (overlay) overlay.remove();
            resetGame();
        }

        function resetGame() {
            if (gameState.gameRunning) {
                // 멀티플레이 중이고 방장이면 다시 시작
                if (multiplayerState.isMultiplayer && multiplayerState.isHost) {
                    if (!confirm('게임을 다시 시작하시겠습니까?')) return;
                    
                    clearInterval(gameState.gameTimer);
                    stopBGM();
                    stopTickSound();
                    document.body.classList.remove('time-warning');
                    
                    // 게임 상태 초기화
                    gameState.score = 0;
                    gameState.usedWords = [];
                    gameState.wordDefinitions = {};
                    
                    // 새 게임 시작
                    setTimeout(() => startGame(), 100);
                    return;
                }
                
                if (!confirm('게임을 종료하시겠습니까?')) return;
            }
            
            clearInterval(gameState.gameTimer);
            stopBGM();
            stopTickSound();
            document.body.classList.remove('time-warning');
            
            document.getElementById('gameStartSection').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('wordInput').value = '';
            gameState.gameRunning = false;
            
            // 모바일 설정 모달 닫기
            closeSettings();
        }

        function resetGameFromSettings() {
            closeSettings();
            setTimeout(() => {
                if (gameState.gameRunning && !confirm('게임을 종료하고 새게임을 시작하시겠습니까?')) return;
                resetGame();
                setTimeout(startGame, 100);
            }, 100);
        }

        function toggleBGM() {
            gameState.bgmEnabled = !gameState.bgmEnabled;
            document.getElementById('bgmBtn').classList.toggle('active');
            if (!gameState.bgmEnabled) stopBGM();
            else if (gameState.gameRunning) playBGM();
        }

        function toggleSFX() {
            gameState.sfxEnabled = !gameState.sfxEnabled;
            document.getElementById('sfxBtn').classList.toggle('active');
        }

        function toggleTyping() {
            gameState.typingEnabled = !gameState.typingEnabled;
            document.getElementById('typingBtn').classList.toggle('active');
        }

        // 모바일 설정 모달 함수
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            syncSettingsModal();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function syncSettingsModal() {
            const bgmBtn = document.getElementById('modalBgmBtn');
            const sfxBtn = document.getElementById('modalSfxBtn');
            const typingBtn = document.getElementById('modalTypingBtn');
            
            bgmBtn.textContent = gameState.bgmEnabled ? 'ON' : 'OFF';
            bgmBtn.classList.toggle('active', gameState.bgmEnabled);
            
            sfxBtn.textContent = gameState.sfxEnabled ? 'ON' : 'OFF';
            sfxBtn.classList.toggle('active', gameState.sfxEnabled);
            
            typingBtn.textContent = gameState.typingEnabled ? 'ON' : 'OFF';
            typingBtn.classList.toggle('active', gameState.typingEnabled);
        }

        function toggleModalBGM() {
            gameState.bgmEnabled = !gameState.bgmEnabled;
            syncSettingsModal();
            if (!gameState.bgmEnabled) stopBGM();
            else if (gameState.gameRunning) playBGM();
        }

        function toggleModalSFX() {
            gameState.sfxEnabled = !gameState.sfxEnabled;
            syncSettingsModal();
        }

        function toggleModalTyping() {
            gameState.typingEnabled = !gameState.typingEnabled;
            syncSettingsModal();
        }

        let bgmAudio = null;

        function playBGM() {
            try {
                const bgmFile = (gameState.roundCount % 2 === 1) ? './background.mp3' : './background2.mp3';
                if (bgmAudio) {
                    bgmAudio.pause();
                    bgmAudio.currentTime = 0;
                }
                bgmAudio = new Audio(bgmFile);
                bgmAudio.loop = true;
                bgmAudio.volume = bgmFile === './background2.mp3' ? 0.4 : 0.3;
                bgmAudio.play().catch(e => {});
            } catch (e) {}
        }

        function stopBGM() {
            if (bgmAudio) {
                bgmAudio.pause();
                bgmAudio.currentTime = 0;
            }
        }

        function fadeOutBGM() {
            if (!bgmAudio) return;
            const fadeInterval = setInterval(() => {
                if (bgmAudio.volume > 0.05) {
                    bgmAudio.volume -= 0.05;
                } else {
                    clearInterval(fadeInterval);
                    bgmAudio.volume = 0;
                }
            }, 200);
        }

        function playScoreSound(score) {
            if (!gameState.sfxEnabled) return;
            let soundFile = '';
            if (score === 10) soundFile = './10.mp3';
            else if (score === 20) soundFile = './20.mp3';
            else if (score >= 30 && score < 100) soundFile = './30.mp3';
            else if (score >= 100 && score < 400) soundFile = './100 110 120.mp3';
            else if (score >= 400 && score < 900) soundFile = './400.mp3';
            else if (score >= 900 && score < 1500) soundFile = './900.mp3';
            else soundFile = './1500.mp3';
            try {
                const audio = new Audio(soundFile);
                audio.volume = 0.5;
                audio.play().catch(e => {});
            } catch (e) {}
        }

        function playWrongSound() {
            if (!gameState.sfxEnabled) return;
            try {
                const audio = new Audio('./wrong.mp3');
                audio.volume = 0.5;
                audio.play().catch(e => {});
            } catch (e) {}
        }

        function playTickSound() {
            if (gameState.tickSoundPlaying) return;
            gameState.tickSoundPlaying = true;
            const tick = document.getElementById('tickSound');
            if (tick) {
                tick.loop = true;
                tick.volume = 0.3;
                tick.play().catch(e => {});
            }
        }

        function stopTickSound() {
            gameState.tickSoundPlaying = false;
            const tick = document.getElementById('tickSound');
            if (tick) {
                tick.pause();
                tick.currentTime = 0;
            }
        }

        function playTypingSound() {
            if (!gameState.typingEnabled) return;
            try {
                const audio = new Audio('./typing.mp3');
                audio.volume = 0.2;
                audio.play().catch(e => {});
            } catch (e) {}
        }

        function saveBestScore(score) {
            if (score > gameState.bestScore) {
                gameState.bestScore = score;
                localStorage.setItem('chosungBestScore', score);
                updateBestScoreDisplay();
            }
        }

        function loadBestScore() {
            const saved = localStorage.getItem('chosungBestScore');
            gameState.bestScore = saved ? parseInt(saved) : 0;
            updateBestScoreDisplay();
        }

        function updateBestScoreDisplay() {
            document.getElementById('bestScoreDisplay').textContent = `🏆 최고 기록: ${gameState.bestScore}점`;
            document.getElementById('currentBestScore').textContent = gameState.bestScore;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadBestScore();
            
            const input = document.getElementById('wordInput');
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    checkWord();
                }
            });
            
            input.addEventListener('input', () => {
                playTypingSound();
            });

            // 모바일에서 스크롤 완전 차단 (게임 중에는)
            if (gameState.isMobile) {
                document.body.style.overflow = 'hidden';
                document.documentElement.style.overflow = 'hidden';
                
                // 게임 중에는 터치무브 차단
                document.addEventListener('touchmove', function preventScrollDuringGame(e) {
                    if (gameState.gameRunning) {
                        e.preventDefault();
                    }
                }, { passive: false });

                // 설정 버튼 표시, 새게임 버튼 숨김
                document.querySelector('.settings-btn').classList.remove('hidden');
                document.querySelector('.reset-btn').classList.add('hidden');
            } else {
                // PC에서는 설정 버튼 숨김, 새게임 버튼 표시
                document.querySelector('.settings-btn').classList.add('hidden');
                document.querySelector('.reset-btn').classList.remove('hidden');
            }
        });


        // ===== 멀티플레이 시스템 (폴링 방식) =====
        const multiplayerState = {
            isMultiplayer: false,
            roomId: null,
            playerId: null,
            playerName: null,
            isHost: false,
            pollingInterval: null,
            lastPlayerCount: 0,
            pendingRoomId: null,
            playerWords: {},
            // 채팅 관련
            chatMessages: [],
            // 슬롯 관련 (이전 점수 저장)
            previousScores: {},
            // 🆕 라운드 추적
            currentRound: 0  // 현재 참여 중인 라운드 번호
        };

        function isPC() {
            return window.innerWidth >= 768;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'mp-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // 🆕 방 목록 자동 새로고침 interval
        let roomListInterval = null;

        async function showRoomList() {
            if (!isPC()) {
                showToast('멀티플레이는 PC에서만 가능합니다');
                return;
            }
            
            // 방 목록 조회 함수
            async function fetchAndDisplayRooms() {
                try {
                    const response = await fetch('https://chosung-scramble.pages.dev/api/rooms');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    const roomList = document.getElementById('mpRoomList');
                    
                    // data가 배열이면 그대로 사용, 아니면 data.rooms 사용, 없으면 빈 배열
                    let rooms = [];
                    if (Array.isArray(data)) {
                        rooms = data;
                    } else if (data && Array.isArray(data.rooms)) {
                        rooms = data.rooms;
                    }
                    
                    // 서버에서 이미 필터링된 방 목록을 받으므로 추가 필터링 불필요
                    if (rooms.length === 0) {
                        roomList.innerHTML = '<div class="mp-empty-message">아직 대기 중인 방이 없어요</div>';
                    } else {
                        roomList.innerHTML = rooms.map((room, index) => {
                            // 🆕 metadata 기반 - playerCount 사용
                            const playerCount = room.playerCount || 0;
                            const statusText = playerCount === 0 ? '대기 중' : `${playerCount}명 대기`;
                            return `
                            <div class="mp-room-item">
                                <div class="mp-room-info">
                                    <div class="mp-room-title">🎮 ${index + 1}번방</div>
                                    <div class="mp-room-players">👤 ${statusText}</div>
                                    <div class="mp-room-status">(${playerCount}/5명)</div>
                                </div>
                                <button class="mp-join-btn" onclick="joinRoom('${room.id}')">입장하기</button>
                            </div>
                        `;
                        }).join('');
                    }
                } catch (error) {
                    console.error('방 목록 로드 실패:', error);
                    const roomList = document.getElementById('mpRoomList');
                    roomList.innerHTML = '<div class="mp-empty-message">방 목록을 불러올 수 없습니다</div>';
                }
            }
            
            // 첫 조회
            await fetchAndDisplayRooms();
            
            // 모달 표시
            const modal = document.getElementById('mpRoomModal');
            modal.classList.remove('hidden');
            
            // 🆕 1초마다 자동 새로고침
            if (roomListInterval) clearInterval(roomListInterval);
            roomListInterval = setInterval(async () => {
                // 모달이 열려있을 때만 새로고침
                if (!document.getElementById('mpRoomModal').classList.contains('hidden')) {
                    await fetchAndDisplayRooms();
                } else {
                    clearInterval(roomListInterval);
                    roomListInterval = null;
                }
            }, 1000);
        }

        function closeRoomModal() {
            document.getElementById('mpRoomModal').classList.add('hidden');
            // 🆕 interval 정리
            if (roomListInterval) {
                clearInterval(roomListInterval);
                roomListInterval = null;
            }
        }

        async function createAndStartSoloWaiting() {
            let playerName = localStorage.getItem('playerName');
            if (!playerName) {
                multiplayerState.pendingRoomId = 'CREATE_NEW';
                closeRoomModal();
                showNameModal();
                return;
            }
            await createRoomAndStart(playerName);
        }

        async function createRoomAndStart(playerName) {
            try {
                const createResponse = await fetch('https://chosung-scramble.pages.dev/api/create-room', { method: 'POST' });
                const createData = await createResponse.json();
                const roomId = createData.roomId;
                multiplayerState.roomId = roomId;
                multiplayerState.playerId = 'player_' + Date.now();
                multiplayerState.playerName = playerName;
                multiplayerState.isHost = true;
                multiplayerState.isMultiplayer = true;
                multiplayerState.lastPlayerCount = 1;
                const joinResponse = await fetch('https://chosung-scramble.pages.dev/api/join-room', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: roomId, playerId: multiplayerState.playerId, playerName: playerName })
                });
                if (!joinResponse.ok) throw new Error('방 입장 실패');
                closeRoomModal();
                showToast('방이 생성되었습니다!');
                // 게임 시작 대신 대기실로 이동
                updateStartScreenButtons();
                startPolling(); // 폴링 시작
                
                // 🆕 빈 슬롯 즉시 표시!
                document.getElementById('playerSlotsLeft').classList.remove('hidden');
                document.getElementById('chatContainer').classList.remove('hidden');
                
                // 🆕 빈 슬롯 5개 먼저 만들기 (대기중 표시)
                const slotsContainer = document.getElementById('playerSlotsLeft');
                slotsContainer.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'player-slot empty';
                    slot.innerHTML = `
                        <div class="player-slot-name">대기중...</div>
                        <div class="player-slot-score">-</div>
                    `;
                    slotsContainer.appendChild(slot);
                }
                
                // 🆕 그 다음에 실제 플레이어 정보로 업데이트
                const roomResponse = await fetch(`https://chosung-scramble.pages.dev/api/game-state?roomId=${roomId}`);
                const roomData = await roomResponse.json();
                updateScoreboard(roomData);
            } catch (error) {
                console.error('방 생성 실패:', error);
                showToast('방 생성에 실패했습니다');
            }
        }

        function joinRoom(roomId) {
            let playerName = localStorage.getItem('playerName');
            if (!playerName) {
                multiplayerState.pendingRoomId = roomId;
                closeRoomModal();
                showNameModal();
                return;
            }
            joinRoomWithName(roomId, playerName);
        }

        async function joinRoomWithName(roomId, playerName) {
            try {
                multiplayerState.playerId = 'player_' + Date.now();
                multiplayerState.playerName = playerName;
                multiplayerState.roomId = roomId;
                multiplayerState.isHost = false;
                multiplayerState.isMultiplayer = true;
                const response = await fetch('https://chosung-scramble.pages.dev/api/join-room', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: roomId, playerId: multiplayerState.playerId, playerName: playerName })
                });
                if (!response.ok) throw new Error('방 입장 실패');
                const data = await response.json();
                closeRoomModal();
                showToast(`${data.roomData.players.length}명의 플레이어가 함께 플레이 중입니다`);
                const stateResponse = await fetch(`https://chosung-scramble.pages.dev/api/game-state?roomId=${roomId}`);
                const roomData = await stateResponse.json();
                joinOngoingGame(roomData);
            } catch (error) {
                console.error('방 입장 실패:', error);
                showToast('방 입장에 실패했습니다');
            }
        }

        function joinOngoingGame(roomData) {
            console.log('[입장] 게임 참여 시도:', {
                gameStarted: roomData.gameStarted,
                hasConsonants: !!roomData.consonants,
                consonantsLength: roomData.consonants ? roomData.consonants.length : 0,
                startTime: roomData.startTime,
                endTime: roomData.endTime
            });

            // 게임이 종료된 방이면
            if (roomData.endTime) {
                console.log('[입장] ❌ 게임이 이미 종료된 방입니다');
                showToast('게임이 이미 종료되었습니다');
                leaveRoom();
                return;
            }

            // 게임이 시작되었고 초성이 있으면 참여
            if (roomData.gameStarted === true && 
                roomData.consonants && 
                Array.isArray(roomData.consonants) && 
                roomData.consonants.length > 0) {
                
                console.log('[입장] ✅ 게임 참여 - 초성:', roomData.consonants);
                joinActiveGame(roomData);
            } else {
                // 게임 대기 중
                console.log('[입장] ⏳ 게임 대기 중');
                multiplayerState.lastPlayerCount = roomData.players ? roomData.players.length : 0;
                startPolling();
                updateStartScreenButtons();
                showToast('게임 시작을 기다리는 중...');
                
                // 🆕 대기 중에도 슬롯 표시
                updateScoreboard(roomData);
            }
        }

        // 활성 게임 참여 함수
        function joinActiveGame(roomData) {
            // 기존 타이머 정리
            if (gameState.gameTimer) clearInterval(gameState.gameTimer);
            
            // 🆕 라운드 번호 설정
            multiplayerState.currentRound = roomData.roundNumber || 0;
            console.log(`[게임 참여] 라운드 ${multiplayerState.currentRound}`);
            
            // 게임 상태 설정
            gameState.gameRunning = true;
            gameState.currentConsonants = roomData.consonants;
            gameState.score = 0;
            gameState.usedWords = [];

            // 남은 시간 계산
            if (roomData.startTime) {
                const elapsedTime = Math.floor((Date.now() - roomData.startTime) / 1000);
                gameState.timeLeft = Math.max(1, 180 - elapsedTime);
                console.log('[입장] 남은 시간:', gameState.timeLeft, '초');
            } else {
                gameState.timeLeft = 180;
            }

            // 화면 전환
            document.getElementById('gameStartSection').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');

            // 멀티플레이 중이면 새게임 버튼 숨기기
            const resetBtn = document.querySelector('.reset-btn');
            if (resetBtn) resetBtn.style.display = 'none';

            // UI 업데이트
            document.getElementById('score').textContent = '0';
            document.getElementById('timer').textContent = gameState.timeLeft;
            displayConsonants(gameState.currentConsonants);
            updateScoreboard(roomData);

            // 타이머 시작
            gameState.gameTimer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft === 10) {
                    document.body.classList.add('time-warning');
                    if (gameState.sfxEnabled) playTickSound();
                    if (bgmAudio && gameState.bgmEnabled) fadeOutBGM();  // 🆕 BGM 페이드아웃
                }
                
                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);

            startPolling();
            showToast('🎮 게임에 참여했습니다!');
            
            // 🆕 BGM 재생 (멀티플레이도!)
            if (gameState.bgmEnabled) playBGM();
        }

        function showNameModal() {
            const modal = document.getElementById('mpNameModal');
            const input = document.getElementById('mpNameInput');
            input.value = '';
            modal.classList.remove('hidden');
            input.focus();
        }

        function confirmName() {
            const input = document.getElementById('mpNameInput');
            const name = input.value.trim();
            if (!name) {
                showToast('이름을 입력해주세요');
                return;
            }
            localStorage.setItem('playerName', name);
            multiplayerState.playerName = name;
            document.getElementById('mpNameModal').classList.add('hidden');
            if (multiplayerState.pendingRoomId === 'CREATE_NEW') {
                createRoomAndStart(name);
            } else if (multiplayerState.pendingRoomId) {
                joinRoomWithName(multiplayerState.pendingRoomId, name);
            }
            multiplayerState.pendingRoomId = null;
        }

        function cancelName() {
            document.getElementById('mpNameModal').classList.add('hidden');
            multiplayerState.pendingRoomId = null;
        }

        function startPolling() {
            if (multiplayerState.pollingInterval) clearInterval(multiplayerState.pollingInterval);
            
            multiplayerState.pollingInterval = setInterval(async () => {
                if (!multiplayerState.isMultiplayer || !multiplayerState.roomId) return;
                
                try {
                    const response = await fetch(`https://chosung-scramble.pages.dev/api/game-state?roomId=${multiplayerState.roomId}`);
                    const roomData = await response.json();
                    
                    // 🆕 라운드 번호 기반 상태 체크
                    const serverRound = roomData.roundNumber || 0;
                    const clientRound = multiplayerState.currentRound;
                    
                    // 1. 게임 종료 감지 (같은 라운드이고 endTime 있음)
                    if (roomData.endTime && serverRound === clientRound && !document.querySelector('.mp-result-modal')) {
                        console.log(`🔴 게임 종료 감지! (라운드 ${serverRound})`);
                        
                        // 게임 화면 숨기기
                        document.getElementById('gameScreen').classList.add('hidden');
                        document.getElementById('gameStartSection').classList.remove('hidden');
                        
                        // 결과 화면 표시
                        showFinalResults(roomData);
                        return;
                    }
                    
                    // 2. 새 게임 시작 감지 (라운드 번호가 증가함)
                    if (serverRound > clientRound && roomData.gameStarted && roomData.consonants) {
                        console.log(`🟢 새 라운드 시작! (${clientRound} → ${serverRound})`);
                        
                        // 결과 화면 닫기
                        document.querySelector('.mp-result-modal')?.remove();
                        
                        // 라운드 번호 업데이트
                        multiplayerState.currentRound = serverRound;
                        
                        // 게임 참여
                        joinActiveGame(roomData);
                        return;
                    }
                    
                    // 3. 플레이어 수 변경 감지
                    if (roomData.players && roomData.players.length !== multiplayerState.lastPlayerCount) {
                        const newPlayer = roomData.players[roomData.players.length - 1];
                        if (roomData.players.length > multiplayerState.lastPlayerCount) {
                            showToast(`${newPlayer.name}님이 입장했습니다`);
                        }
                        multiplayerState.lastPlayerCount = roomData.players.length;
                        
                        // 🆕 대기 중에도 슬롯 업데이트
                        if (!gameState.gameRunning) {
                            updateScoreboard(roomData);
                        }
                    }
                    
                    // 4. 점수판 업데이트 (게임 중일 때만)
                    if (gameState.gameRunning) {
                        updateScoreboard(roomData);
                    }
                    
                } catch (error) {
                    console.error('폴링 에러:', error);
                }
            }, 500); // 🆕 1초→500ms로 단축해서 더 빠른 업데이트
        }

        function stopPolling() {
            if (multiplayerState.pollingInterval) {
                clearInterval(multiplayerState.pollingInterval);
                multiplayerState.pollingInterval = null;
            }
        }

        function updateScoreboard(roomData) {
            // 🆕 멀티플레이 중이면 항상 슬롯 표시 (혼자 있어도!)
            if (multiplayerState.isMultiplayer) {
                document.getElementById('playerSlotsLeft').classList.remove('hidden');
                document.getElementById('chatContainer').classList.remove('hidden');
                updatePlayerSlots(roomData);
                return;
            }
            
            // 싱글플레이는 기존 로직
            if (!roomData.players || roomData.players.length < 2) {
                document.getElementById('playerSlotsLeft').classList.add('hidden');
                document.getElementById('chatContainer').classList.add('hidden');
                return;
            }

            // 슬롯 + 채팅 표시
            document.getElementById('playerSlotsLeft').classList.remove('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');

            // 플레이어 슬롯 업데이트
            updatePlayerSlots(roomData);
        }

        // 플레이어 슬롯 업데이트 (점수 애니메이션 포함)
        function updatePlayerSlots(roomData) {
            // 순위별로 정렬
            const sortedPlayers = roomData.players
                .map(player => {
                    const playerWords = roomData.playerWords?.[player.id] || [];
                    const highestScore = playerWords.length > 0 
                        ? Math.max(...playerWords.map(w => w.score))
                        : 0;
                    
                    return {
                        ...player,
                        score: roomData.scores?.[player.id] || 0,
                        wordCount: playerWords.length,
                        highestScore: highestScore
                    };
                })
                .sort((a, b) => b.score - a.score);

            const slotsContainer = document.getElementById('playerSlotsLeft');
            
            // 최대 5개 슬롯 (방 최대 인원)
            const maxSlots = 5;
            let html = '';

            // 실제 플레이어 슬롯
            for (let i = 0; i < sortedPlayers.length && i < maxSlots; i++) {
                const player = sortedPlayers[i];
                const isMe = player.id === multiplayerState.playerId;
                const rankText = `${i + 1}위`;
                
                html += `
                    <div class="player-slot" data-player-id="${player.id}">
                        <div class="slot-header">
                            <div class="slot-name">${rankText} ${player.name}${isMe ? ' (나)' : ''}</div>
                            <div class="slot-status">🟢</div>
                        </div>
                        <div class="slot-info">
                            <div class="slot-info-row">
                                <span class="icon">💰</span>
                                <span class="slot-score">${player.score.toLocaleString()}점</span>
                            </div>
                            <div class="slot-info-row">
                                <span class="icon">📝</span>
                                <span>단어 ${player.wordCount}개</span>
                            </div>
                            <div class="slot-info-row">
                                <span class="icon">🏆</span>
                                <span>최고득점 ${player.highestScore}점</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 빈 슬롯 추가
            for (let i = sortedPlayers.length; i < maxSlots; i++) {
                html += `
                    <div class="player-slot empty">
                        <div class="player-slot-name">대기중...</div>
                        <div class="player-slot-score">-</div>
                    </div>
                `;
            }

            slotsContainer.innerHTML = html;

            // 점수 변화 감지 및 팝업 애니메이션
            sortedPlayers.forEach(player => {
                const previousScore = multiplayerState.previousScores[player.id] || 0;
                const currentScore = player.score;
                
                if (currentScore > previousScore && previousScore > 0) {
                    const scoreDiff = currentScore - previousScore;
                    showScorePopup(player.id, scoreDiff);
                }
                
                // 현재 점수 저장
                multiplayerState.previousScores[player.id] = currentScore;
            });
        }

        // 점수 팝업 표시
        function showScorePopup(playerId, scoreDiff) {
            const slot = document.querySelector(`[data-player-id="${playerId}"]`);
            if (!slot) return;

            // 기존 팝업 제거
            const existingPopup = slot.querySelector('.slot-popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            // 새 팝업 생성
            const popup = document.createElement('div');
            popup.className = 'slot-popup';
            popup.textContent = `+${scoreDiff}!`;
            slot.appendChild(popup);

            // 1초 후 제거
            setTimeout(() => {
                popup.remove();
            }, 1000);
        }

        // 채팅 메시지 전송 (로컬만 - 서버 연동은 나중에)
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (!multiplayerState.isMultiplayer || !multiplayerState.roomId) return;

            try {
                // TODO: 서버에 채팅 메시지 전송 (나중에 구현)
                // 지금은 로컬에만 표시
                addChatMessage(multiplayerState.playerName, message);
                input.value = '';
                
                // 게임 입력창으로 포커스 복귀
                document.getElementById('wordInput').focus();
            } catch (error) {
                console.error('채팅 전송 실패:', error);
            }
        }

        // 채팅 메시지 추가
        function addChatMessage(playerName, message) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `
                <span class="chat-name">${playerName}:</span>
                <span class="chat-text">${message}</span>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // 최대 50개 메시지만 유지
            while (chatMessages.children.length > 50) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
            
            // 스크롤 맨 아래로
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function updatePlayerScore() {
            if (!multiplayerState.isMultiplayer || !multiplayerState.roomId) return;
            try {
                // usedWords는 단어만 저장되어 있으므로, 각 단어의 점수를 다시 계산
                const words = gameState.usedWords.map(word => {
                    const chosung = getChosung(word);
                    const scoreInfo = calculateScore(word, chosung);
                    return { 
                        word: word, 
                        score: scoreInfo.total 
                    };
                });
                
                await fetch(`https://chosung-scramble.pages.dev/api/game-state?roomId=${multiplayerState.roomId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerId: multiplayerState.playerId, score: gameState.score, words: words })
                });
                multiplayerState.playerWords[multiplayerState.playerId] = words;
            } catch (error) {
                console.error('점수 업데이트 실패:', error);
            }
        }

        async function sendGameStart(isNewRound = false) {
            if (!multiplayerState.isMultiplayer || !multiplayerState.roomId) return;
            try {
                const action = isNewRound ? 'new_game' : 'start_game';
                console.log(`🎯 [방장] ${action} 신호 전송:`, gameState.currentConsonants);
                await fetch(`https://chosung-scramble.pages.dev/api/game-state?roomId=${multiplayerState.roomId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: action, 
                        consonants: gameState.currentConsonants, 
                        startTime: Date.now(),
                        timeLeft: 180 
                    })
                });
            } catch (error) {
                console.error('게임 시작 전송 실패:', error);
            }
        }

        async function sendGameEnd() {
            if (!multiplayerState.isMultiplayer || !multiplayerState.roomId) return;
            try {
                await fetch(`https://chosung-scramble.pages.dev/api/game-state?roomId=${multiplayerState.roomId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'end_game' })
                });
            } catch (error) {
                console.error('게임 종료 전송 실패:', error);
            }
        }

        function showFinalResults(roomData) {
            // 🆕 이미 모달이 있으면 중복 실행 방지!
            if (document.querySelector('.mp-result-modal')) {
                console.log('⚠️ 이미 결과 모달 존재 - 중복 방지');
                return;
            }
            
            // finished 소리 재생! (한 번만!)
            if (gameState.sfxEnabled) {
                try {
                    const finishedSound = new Audio('./finished.mp3');
                    finishedSound.volume = 0.5;
                    finishedSound.play().catch(e => console.log('소리 재생 실패:', e));
                } catch (e) {
                    console.log('소리 로드 실패:', e);
                }
            }

            const results = roomData.players
                .map(player => ({
                    id: player.id,
                    name: player.name,
                    score: roomData.scores?.[player.id] || 0,
                    words: roomData.playerWords?.[player.id] || []
                }))
                .sort((a, b) => b.score - a.score);
                
            const modal = document.createElement('div');
            modal.className = 'mp-result-modal';
            
            // 🆕 더 작은 모달로 변경 (채팅창 가리지 않도록)
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 10000;
                max-width: 500px;
                width: 90%;
                max-height: 70vh;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div class="mp-result-content">
                    <div class="mp-result-title">🏆 게임 종료!</div>
                    ${results.map((player, index) => {
                        const topWords = player.words.sort((a, b) => b.score - a.score).slice(0, 3);
                        const isMe = player.id === multiplayerState.playerId;
                        return `
                            <div class="mp-result-player ${index === 0 ? 'rank-1' : ''}">
                                <div class="mp-result-player-header">
                                    <div class="mp-result-player-name">
                                        ${index === 0 ? '👑' : `${index + 1}위`} ${player.name}
                                    </div>
                                    <div class="mp-result-player-score">${player.score.toLocaleString()}점</div>
                                </div>
                                <div class="mp-result-player-stats">
                                    맞춘 단어: ${player.words.length}개
                                    ${isMe ? `<button onclick="showStudyNote('${player.id}')" style="margin-left:10px;padding:2px 8px;font-size:0.8em;">📝 학습노트</button>` : ''}
                                </div>
                                <div class="mp-result-player-words">
                                    TOP3: ${topWords.map(w => `${w.word}(${w.score})`).join(', ') || '없음'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                    <div class="mp-result-buttons">
                        ${multiplayerState.isHost 
                            ? '<button class="mp-result-btn replay" onclick="restartMultiplayerGame()">다시하기</button>' 
                            : '<div class="mp-waiting-message">방장이 다음 게임을 시작할 때까지 기다려주세요</div>'}
                        <button class="mp-result-btn home" onclick="goToHome()">방 나가기</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 🆕 채팅창은 계속 활성화 유지
            document.getElementById('chatContainer').classList.remove('hidden');
            
            // 🆕 roomData를 전역에 저장 (학습노트용)
            window.lastGameResults = roomData;
        }
        
        // 🆕 학습노트 표시 함수
        function showStudyNote(playerId) {
            const playerWords = window.lastGameResults?.playerWords?.[playerId] || [];
            if (playerWords.length === 0) {
                showToast('학습할 단어가 없습니다');
                return;
            }
            
            const noteModal = document.createElement('div');
            noteModal.className = 'study-note-modal';
            noteModal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 10001;
                background: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            const sortedWords = playerWords.sort((a, b) => b.score - a.score);
            
            noteModal.innerHTML = `
                <h2 style="margin-bottom:15px;color:#fd79a8;">📝 나의 학습노트</h2>
                <div style="margin-bottom:10px;color:#636e72;">총 ${playerWords.length}개 단어 | 총점: ${playerWords.reduce((sum, w) => sum + w.score, 0).toLocaleString()}점</div>
                <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;">
                    ${sortedWords.map(w => `
                        <span style="
                            padding:5px 10px;
                            background:${w.score >= 100 ? '#ffe066' : '#f8f9fa'};
                            border:2px solid ${w.score >= 100 ? '#ffd43b' : '#dee2e6'};
                            border-radius:10px;
                            font-weight:${w.score >= 100 ? 'bold' : 'normal'};
                        ">${w.word}(${w.score})</span>
                    `).join('')}
                </div>
                <button onclick="this.parentElement.remove()" style="
                    padding:10px 20px;
                    background:#fd79a8;
                    color:white;
                    border:none;
                    border-radius:10px;
                    font-weight:bold;
                    cursor:pointer;
                    width:100%;
                ">닫기</button>
            `;
            
            document.body.appendChild(noteModal);
        }

        function restartMultiplayerGame() {
            if (!multiplayerState.isHost) {
                showToast('방장만 게임을 시작할 수 있습니다');
                return;
            }
            
            document.querySelector('.mp-result-modal')?.remove();
            
            // 🆕 즉시 라운드 증가 (폴링에서 finished 재생 방지!)
            multiplayerState.currentRound++;
            
            showToast('새로운 게임을 시작합니다...');
            
            // 🆕 게임 화면 먼저 표시 (시작 화면에서 게임 화면으로)
            document.getElementById('gameStartSection').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // 슬롯 + 채팅 다시 표시 (두 번째 판부터 안 보이던 버그 수정!)
            document.getElementById('playerSlotsLeft').classList.remove('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            
            // 폴링 재시작 (다른 플레이어도 게임 시작 감지하도록)
            startPolling();
            
            // 잠시 후 게임 시작 (🆕 isNewRound = true)
            setTimeout(() => startGame(true), 1000);
        }

        async function goToHome() {
            // 🆕 서버에 나가기 신호 전송
            if (multiplayerState.roomId && multiplayerState.playerId) {
                try {
                    await fetch('https://chosung-scramble.pages.dev/api/leave-room', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roomId: multiplayerState.roomId,
                            playerId: multiplayerState.playerId
                        })
                    });
                } catch (error) {
                    console.error('방 나가기 전송 실패:', error);
                }
            }
            
            stopPolling();
            multiplayerState.isMultiplayer = false;
            multiplayerState.roomId = null;
            multiplayerState.isHost = false;
            multiplayerState.currentRound = 0;  // 🆕 라운드 초기화
            document.querySelector('.mp-result-modal')?.remove();
            
            // 슬롯 + 채팅 숨기기
            document.getElementById('playerSlotsLeft').classList.add('hidden');
            document.getElementById('chatContainer').classList.add('hidden');
            
            // 싱글플레이로 돌아가니 새게임 버튼 복원
            const resetBtn = document.querySelector('.reset-btn');
            if (resetBtn) resetBtn.style.display = 'block';
            
            // 게임 화면 → 시작 화면
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('gameStartSection').classList.remove('hidden');
            
            resetGame();
            updateStartScreenButtons();
        }

        const originalStartGame = startGame;
        startGame = function(isNewRound = false) {
            originalStartGame();
            if (multiplayerState.isMultiplayer && multiplayerState.isHost) {
                // 초성이 생성될 때까지 잠깐 대기
                setTimeout(() => {
                    sendGameStart(isNewRound);
                    startPolling();
                }, 100);
            }
        };

        const originalEndGame = endGame;
        endGame = function() {
            console.log('endGame 호출됨! 멀티:', multiplayerState.isMultiplayer);
            
            // 멀티플레이 중이면
            if (multiplayerState.isMultiplayer) {
                // 게임 상태만 정리 (화면은 안 바꿈)
                clearInterval(gameState.gameTimer);
                gameState.gameRunning = false;
                document.body.classList.remove('time-warning');
                stopTickSound();
                stopBGM();  // 🆕 BGM 중지
                
                console.log('방장인가?', multiplayerState.isHost);
                
                // 방장만 게임 종료 신호 전송
                if (multiplayerState.isHost) {
                    console.log('게임 종료 신호 전송!');
                    sendGameEnd();
                }
                
                // 폴링은 계속 (결과 화면 대기)
                showToast('게임이 종료되었습니다. 결과를 집계 중...');
                
                // 🆕 5초 후에도 결과 모달 안 뜨면 강제로 표시 (무한 루프 방지!)
                setTimeout(async () => {
                    if (!document.querySelector('.mp-result-modal')) {
                        console.log('⚠️ 타임아웃! 강제로 결과 표시');
                        try {
                            const response = await fetch(`https://chosung-scramble.pages.dev/api/game-state?roomId=${multiplayerState.roomId}`);
                            const roomData = await response.json();
                            showFinalResults(roomData);
                        } catch (e) {
                            console.error('결과 가져오기 실패:', e);
                        }
                    }
                }, 5000);
            } else {
                // 싱글플레이는 기존 로직
                originalEndGame();
            }
        };

        const originalCheckWord = checkWord;
        checkWord = function() {
            originalCheckWord();
            if (multiplayerState.isMultiplayer) {
                setTimeout(() => updatePlayerScore(), 100);
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            if (!isPC()) {
                const togetherBtn = document.querySelector('.mode-start-btn.together');
                if (togetherBtn) togetherBtn.remove();
            }
            const nameInput = document.getElementById('mpNameInput');
            if (nameInput) {
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') confirmName();
                });
            }
            
            // 채팅 입력창 엔터키 이벤트
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
            
            // 시작 화면 버튼 초기화
            updateStartScreenButtons();
        });
        
        // 🆕 페이지 떠날 때 방 나가기 처리
        window.addEventListener('beforeunload', async (e) => {
            if (multiplayerState.isMultiplayer && multiplayerState.roomId && multiplayerState.playerId) {
                // 비동기로 서버에 나가기 신호 전송
                navigator.sendBeacon('https://chosung-scramble.pages.dev/api/leave-room', 
                    JSON.stringify({
                        roomId: multiplayerState.roomId,
                        playerId: multiplayerState.playerId
                    })
                );
            }
        });
        
        // 🆕 페이지 visibility 변경 시 처리 (모바일 브라우저 대응)
        document.addEventListener('visibilitychange', async () => {
            if (document.hidden && multiplayerState.isMultiplayer && multiplayerState.roomId) {
                // 페이지가 숨겨질 때 (탭 전환, 브라우저 최소화 등)
                try {
                    await fetch('https://chosung-scramble.pages.dev/api/leave-room', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roomId: multiplayerState.roomId,
                            playerId: multiplayerState.playerId
                        })
                    });
                } catch (error) {
                    console.error('방 나가기 실패:', error);
                }
            }
        });
        
        // 🆕 페이지 나가기/새로고침 감지
        window.addEventListener('beforeunload', async (e) => {
            if (multiplayerState.isMultiplayer && multiplayerState.roomId && multiplayerState.playerId) {
                // 나가기 신호 즉시 전송 (동기적으로)
                const data = JSON.stringify({
                    roomId: multiplayerState.roomId,
                    playerId: multiplayerState.playerId
                });
                
                // sendBeacon을 사용하면 페이지 나가기 전에 확실히 전송됨
                navigator.sendBeacon('https://chosung-scramble.pages.dev/api/leave-room', data);
            }
        });
        
        // 🆕 모바일 백그라운드 전환도 감지
        document.addEventListener('visibilitychange', async () => {
            if (document.hidden && multiplayerState.isMultiplayer && multiplayerState.roomId) {
                // 모바일에서 앱 전환 시에도 나가기 처리
                try {
                    await fetch('https://chosung-scramble.pages.dev/api/leave-room', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roomId: multiplayerState.roomId,
                            playerId: multiplayerState.playerId
                        })
                    });
                } catch (error) {
                    console.log('백그라운드 나가기 처리:', error);
                }
            }
        });
        
        // 시작 화면 버튼 업데이트
        function updateStartScreenButtons() {
            const buttonsContainer = document.getElementById('gameModeButtons');
            if (!buttonsContainer) return;
            
            // 멀티플레이 중이면
            if (multiplayerState.isMultiplayer && multiplayerState.roomId) {
                let buttonsHTML = '';
                
                // 방장이면 게임 시작 버튼
                if (multiplayerState.isHost) {
                    buttonsHTML += `
                        <button class="mode-start-btn solo" onclick="startMultiplayerRound()">
                            🎮 게임 시작
                        </button>
                    `;
                }
                
                // 나가기 버튼
                buttonsHTML += `
                    <button class="mode-start-btn together" onclick="leaveRoom()">
                        🚪 나가기
                    </button>
                `;
                
                buttonsContainer.innerHTML = buttonsHTML;
            } else {
                // 싱글 모드 버튼
                let buttonsHTML = `
                    <button class="mode-start-btn solo" onclick="startGame()">
                        🎮 혼자하기
                    </button>
                `;
                
                // PC에서만 함께하기 버튼
                if (isPC()) {
                    buttonsHTML += `
                        <button class="mode-start-btn together" onclick="showRoomList()">
                            👥 함께하기
                        </button>
                    `;
                }
                
                buttonsContainer.innerHTML = buttonsHTML;
            }
        }
        
        // 멀티플레이 라운드 시작
        function startMultiplayerRound() {
            if (!multiplayerState.isHost) return;
            startGame();
        }
        
        // 방 나가기
        async function leaveRoom() {
            // 🆕 서버에 나가기 신호 전송
            if (multiplayerState.roomId && multiplayerState.playerId) {
                try {
                    await fetch('https://chosung-scramble.pages.dev/api/leave-room', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roomId: multiplayerState.roomId,
                            playerId: multiplayerState.playerId
                        })
                    });
                } catch (error) {
                    console.error('방 나가기 전송 실패:', error);
                }
            }
            
            stopPolling();
            multiplayerState.isMultiplayer = false;
            multiplayerState.roomId = null;
            multiplayerState.isHost = false;
            multiplayerState.currentRound = 0;  // 🆕 라운드 초기화
            
            // 슬롯 + 채팅 숨기기
            document.getElementById('playerSlotsLeft').classList.add('hidden');
            document.getElementById('chatContainer').classList.add('hidden');
            
            // 싱글플레이로 돌아가니 새게임 버튼 복원
            const resetBtn = document.querySelector('.reset-btn');
            if (resetBtn) resetBtn.style.display = 'block';
            
            updateStartScreenButtons();
            showToast('방에서 나왔습니다');
        }

        function leaveGameRoom() {
            if (gameState.gameRunning) {
                showToast('게임 중에는 나갈 수 없습니다');
                return;
            }
            leaveRoom();
        }
    </script>
</body>
</html>
