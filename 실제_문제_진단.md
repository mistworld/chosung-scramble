# 실제 문제 진단

## 🚨 사용자 불만 사항
1. "처음부터 슬롯 안보임"
2. "DO 단일로 고치는게 맞는거야?"
3. "2번째 정도 고쳤을때가 그나마 젤 잘됐는데 오히려 퇴보"
4. "테스트하는것조차 짜증이 나"

## 🔍 코드 분석 결과

### 현재 구현 상태
1. ✅ 서버에서 `doState` 반환 (1628줄)
2. ✅ `doState.players = finalPlayers` 설정 (1567줄)
3. ✅ 프론트엔드에서 `updateScoreboard(roomData)` 호출 (5947줄)
4. ✅ `updateScoreboard`가 `roomData.players` 체크 (6292줄)

### 코드상 문제는 없어 보임
- 하지만 실제로 동작하지 않는다면...

## 🎯 실제 문제 가능성

### 1. 방 생성 직후 players가 비어있음?
- 방 생성 시 DO에 첫 플레이어 추가 확인 필요
- `handleCreateRoom`에서 `add_player` 액션이 실행되는지 확인

### 2. DO 상태 저장 타이밍 문제?
- `persistState`가 비동기인데 응답을 너무 빨리 보내는 경우
- DO 상태가 저장되기 전에 조회하는 경우

### 3. 프론트엔드에서 players 필드 누락?
- 서버 응답에 players가 있어도
- 클라이언트에서 파싱 시 누락되는 경우

## 💡 제안

### 즉시 확인할 것:
1. **브라우저 콘솔 로그 확인**
   - `[game-state] DO players 사용: X명` 로그가 나오는지
   - `[슬롯] roomData.players가 없거나 배열이 아님` 경고가 나오는지

2. **서버 로그 확인** (`npx wrangler tail`)
   - 방 생성 시 `[DO] 플레이어 추가` 로그 확인
   - game-state GET 요청 시 `finalPlayers` 로그 확인

3. **네트워크 탭 확인**
   - `/api/game-state` 응답에 `players` 배열이 포함되는지
   - 빈 배열인지, 아니면 필드 자체가 없는지

### 근본 원인 파악을 위해:
- 방 생성 → 입장 → 폴링 전체 플로우를 로그로 추적
- 각 단계에서 `players` 배열의 상태 확인

---

## 🤔 DO 단일 소스가 맞는가?

**현재 구조:**
- DO: 게임 상태 (players, scores, gameState 등)
- KV: 메타데이터만 (roomNumber, title, createdAt 등)

**문제점:**
- DO는 강력하지만 복잡함
- 타이밍 이슈 가능성
- 디버깅이 어려움

**대안:**
- KV도 players를 저장하되, DO와 동기화
- 또는 DO만 사용하되, 상태 저장 타이밍 명확히

**하지만:**
- 이미 DO로 전환했고, 되돌리면 또 문제 생길 수 있음
- 현재 구조에서 문제만 찾아서 고치는게 나을 수도
