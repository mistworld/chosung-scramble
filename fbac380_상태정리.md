# fbac380 버전 상태 및 문제점 정리

## 📌 현재 버전 정보
- **커밋**: `fbac380`
- **메시지**: `Fix: Time mode polling cleanup, room list stability, entry retry, score instant update`
- **상태**: ✅ 깔끔하게 되돌림 완료

---

## ✅ 이 버전(fbac380)에 실제로 포함된 수정사항

### 1. 입장 재시도 로직 (public/index.html)
- `joinRoomWithName`에서 입장 후 `game-state` 가져올 때 재시도 로직 추가
- 최대 3회 재시도, 200ms 간격
- `players` 배열에 내 `playerId`가 있을 때까지 재시도

### 2. 점수 즉시 반영 (public/index.html)
- `checkWord` 함수에서 `setTimeout(100ms)` 제거
- `updatePlayerScore()` 즉시 호출 (딜레이 없음)

### 3. 방 목록 안정성 (src/worker.js)
- 시간제 모드: `activePlayers.length === 0`이어도 `players.length > 0`이면 방 목록에 표시
- `playerCount` 계산 시 시간제 모드 예외 처리 추가

### 4. 시간제 모드 폴링 시 비활성 플레이어 정리 (src/worker.js)
- `handleGameState` GET에서 시간제 모드 + 게임 중이 아닐 때 비활성 플레이어 제거
- `lastSeen` 기준 15초 타임아웃
- 비동기로 KV 업데이트 (응답 지연 최소화)

---

## ❌ 이 버전의 알려진 문제점

### 1. 종료 모달에서 비활성 플레이어 필터링 문제
- **문제**: 종료 모달 표시 시 `lastSeen` 15초 타임아웃 체크로 인해 정상 플레이어도 제거될 수 있음
- **원인**: 종료 모달이 뜨는 시점에 폴링이 멈추거나 `lastSeen` 업데이트가 안 되면 타임아웃 발생
- **증상**: 아무도 나가지 않았는데 슬롯이 제거됨

### 2. 방장 판단 로직 복잡함
- **문제**: 종료 모달에서 방장 판단 시 `activePlayers` 필터링 후 첫 번째를 사용하는데, 이게 복잡하고 오류 가능성 있음
- **원인**: `lastSeen` 체크를 두 번 수행 (results 생성 시, 방장 판단 시)
- **증상**: "다시하기" 버튼이 둘 다에게 보이거나, 방장이 아닌데 보이는 경우

### 3. 게임 시작 시 방장 설정 없음
- **문제**: 새 게임 시작 시 전판 1등을 방장으로 설정하는 로직이 없음
- **원인**: `new_game` 액션에서 `players` 배열 순서 변경 없음
- **증상**: 이전 방장이 계속 방장으로 유지됨

### 4. 게임 시작 시 슬롯 체크 문제
- **문제**: 게임 시작 시 "실시간 슬롯 다시 한번 체크"가 제대로 작동하지 않을 수 있음
- **증상**: 게임 시작 후 타이머가 멈추거나, 잘못된 플레이어 수로 시작

### 5. 점수 업데이트 지연 (부분 해결됨)
- **문제**: 다른 플레이어 화면에서 점수 업데이트가 한 단어씩 밀릴 수 있음
- **원인**: 서버 측 `handleGameState` POST에서 점수 업데이트 후 KV 저장이 안 되거나, 폴링 지연
- **상태**: 클라이언트 측은 수정됨 (`await checkWord()`), 서버 측은 확인 필요

---

## 🔍 확인이 필요한 부분

### 1. `lastSeen` 메커니즘
- `lastSeen`은 폴링 시마다 업데이트되는가?
- 게임 종료 후 모달 표시 중에도 폴링이 계속되는가?
- `lastSeen` 업데이트 로직이 어디에 있는가?

### 2. 종료 모달 표시 시점
- 종료 모달이 뜨는 시점의 `roomData.players` 상태
- 게임 종료 후 비활성 플레이어 정리가 이미 완료되었는가?
- 종료 모달에서 `lastSeen` 체크가 필요한가?

### 3. 방장 판단 기준
- 종료 모달에서: `roomData.players[0].id`를 사용하면 되는가?
- 게임 시작 시: 전판 1등을 첫 번째로 이동시키는 로직 필요
- 폴링 중: `roomData.players[0].id` 기준으로 `multiplayerState.isHost` 업데이트

---

## 📋 사용자가 원하는 수정 방향

### 1. 종료 모달 단순화
- `lastSeen` 체크 제거
- `roomData.players`를 그대로 사용
- 게임 중 브라우저 종료로 나간 플레이어는 이미 `new_game` 시점에 제거되었으므로 문제없음

### 2. 방장 판단 단순화
- 항상 `roomData.players[0].id` 기준
- 복잡한 필터링 로직 제거

### 3. 게임 시작 시 방장 재설정
- `new_game` 액션에서 전판 점수 기준 1등을 `players` 배열 첫 번째로 이동
- 점수 초기화 전에 점수 확인

---

## 🎯 다음 단계 작업 계획

### 우선순위 1: 종료 모달 수정
1. `showFinalResults`에서 `lastSeen` 체크 제거
2. `roomData.players`를 그대로 사용하여 `results` 생성
3. 방장 판단을 `roomData.players[0].id`로 단순화

### 우선순위 2: 게임 시작 시 방장 재설정
1. `new_game` 액션에서 비활성 플레이어 제거 후
2. 전판 점수 기준으로 정렬 (점수 초기화 전)
3. 1등을 `players` 배열 첫 번째로 이동
4. 그 다음 점수/단어 초기화

### 우선순위 3: 게임 시작 후 타이머 멈춤 문제 해결
1. `restartMultiplayerGame` 함수 확인
2. `joinActiveGame` 함수에서 타이머 시작 로직 확인
3. `game-state` 응답의 `startTime` 확인

---

## 📝 참고사항

- **시간제 모드**: KV 단일 소스 (DO 사용 안 함)
- **턴제 모드**: DO 단일 소스
- **폴링 간격**: 800ms
- **비활성 플레이어 타임아웃**: 15초 (게임 시작 시만 적용, 종료 모달에서는 불필요)

---

## ⚠️ 주의사항

1. 하나를 수정하면 다른 부분이 망가질 수 있으므로 신중하게 수정
2. 시간제 모드와 턴제 모드를 명확히 구분하여 처리
3. 테스트가 어렵다고 하셨으므로, 작은 단위로 수정하고 검증

---

## 🔧 배포 상태

- **Git**: `fbac380` 커밋으로 되돌림 완료
- **Vercel**: Git push 필요 (`git push vercel HEAD:main`)
- **Cloudflare Worker**: `npx wrangler deploy` 필요

---

**작성일**: 2025-01-14  
**목적**: 새창에서 작업할 때 참고용
