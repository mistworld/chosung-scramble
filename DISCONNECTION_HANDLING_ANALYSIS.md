# 🔍 나가기 버튼 vs 브라우저 종료 분석

## 핵심 인사이트

### 나가기 버튼과 브라우저 종료는 **별개 문제가 아님**

둘 다 **같은 근본 문제(DO-KV 동기화 타이밍)의 다른 증상**입니다.

## 현재 상황

### 1. 나가기 버튼 (정상 나가기)
```javascript
// leave-room API 호출
→ DO에서 제거 (remove_player)
→ persistState 완료 대기 (100ms)
→ KV 동기화
→ 클라이언트 폴링 (500ms 간격)
→ 최대 500ms 지연
```

**문제**: DO-KV 동기화 타이밍 문제로 슬롯이 즉시 반영 안 됨

### 2. 브라우저 종료
```javascript
// beforeunload → sendBeacon
navigator.sendBeacon('/api/leave-room', ...)
```

**문제**: 
- `sendBeacon`은 **완료 보장 안 됨** (비동기, 응답 기다리지 않음)
- 서버에서 처리되기 전에 브라우저가 닫힘
- DO에서 제거되지만 KV 동기화가 안 됨

### 3. 브라우저 강제 종료 (F5, Ctrl+Shift+Delete 등)
```javascript
// beforeunload도 호출 안 됨
→ 서버는 플레이어가 살아있는 줄 알고 있음
→ 10초 후 비활성 플레이어 자동 제거 (이미 구현됨)
```

## 근본 원인

### DO-KV 동기화 타이밍 문제

```
정상 나가기:
1. leave-room 요청 → DO에서 제거
2. persistState 완료 (100ms)
3. KV 동기화 시작
4. 클라이언트 폴링 → DO 상태 받음 (최신)
5. 다른 클라이언트 폴링 → KV 상태 받음 (이전) ← 문제!

브라우저 종료:
1. sendBeacon → leave-room 요청
2. 브라우저 닫힘 (응답 기다리지 않음)
3. DO에서 제거 완료
4. KV 동기화 실패 또는 지연
5. 다른 클라이언트 폴링 → KV 상태 받음 (이전) ← 문제!
```

**결론**: 둘 다 **같은 동기화 문제**입니다.

## 다른 웹앱 개발자들의 방법

### 1. **Heartbeat/Ping** (가장 일반적)
```javascript
// 주기적으로 서버에 신호 보내기
setInterval(() => {
  fetch('/api/ping?playerId=...')
}, 5000); // 5초마다
```

**우리**: 이미 `lastSeen` 구현됨 (game-state 폴링 시 자동 업데이트)

### 2. **서버 측 자동 감지** (비활성 플레이어 제거)
```javascript
// 서버에서 lastSeen 체크하여 비활성 플레이어 자동 제거
if (now - lastSeen > TIMEOUT) {
  removePlayer(playerId);
}
```

**우리**: 이미 구현됨 (10초 타임아웃)

### 3. **WebSocket** (실시간 연결)
```javascript
// 실시간 양방향 통신
ws.on('close', () => {
  removePlayer(playerId);
});
```

**우리**: Cloudflare Workers에서 WebSocket 지원 제한적

### 4. **낙관적 업데이트** (Optimistic Update)
```javascript
// 클라이언트에서 먼저 반영
removePlayerFromUI(playerId);
// 서버 동기화는 나중에
fetch('/api/leave-room', ...);
```

**우리**: 부분적으로 구현됨 (하지만 서버 동기화 문제로 롤백됨)

## 해결 방안

### 옵션 1: **DO를 단일 소스로, KV는 메타데이터만** (추천)

**원칙**:
- **KV**: `players` 배열 저장 안 함, `playerCount`만 메타데이터로
- **DO**: `players` 단일 소스
- **game-state**: DO만 사용, KV 무시

**장점**:
- 동기화 문제 완전 해결
- 나가기 버튼, 브라우저 종료 모두 해결
- 과거에 잘 작동했던 부분 유지

### 옵션 2: **Heartbeat 강화 + 서버 측 자동 감지**

**현재**:
- `lastSeen` 이미 있음 (game-state 폴링 시 자동 업데이트)
- 비활성 플레이어 자동 제거 이미 구현됨 (10초)

**개선**:
- Heartbeat 간격 단축 (현재 500ms 폴링 = 이미 Heartbeat 역할)
- 타임아웃 단축 (10초 → 5초)

**단점**:
- 여전히 지연 존재 (5초)
- 근본적인 동기화 문제는 해결 안 됨

### 옵션 3: **낙관적 업데이트 + 서버 동기화**

**방법**:
- 클라이언트에서 먼저 슬롯 제거
- 서버 동기화는 백그라운드에서
- 서버 응답이 다르면 롤백

**단점**:
- 복잡함
- 서버 동기화 문제가 여전히 있으면 롤백 반복

## 추천: 옵션 1 (DO 단일 소스)

### 이유

1. **나가기 버튼 문제 해결**
   - DO에서 제거 → 즉시 반영 (KV 동기화 불필요)
   - 폴링 시 항상 DO 상태 반환

2. **브라우저 종료 문제 해결**
   - `sendBeacon` 실패해도 서버 측 자동 감지 (10초)
   - DO에서 제거 → 즉시 반영

3. **과거에 잘 작동했던 부분 유지**
   - DO의 일관성 유지
   - KV는 방 목록 조회용으로만 사용

### 구현

1. **KV에서 `players` 제거**
   ```javascript
   // 저장 안 함
   // roomData.players = [...] // 제거
   ```

2. **DO에서만 `players` 관리**
   ```javascript
   // join-room, leave-room 모두 DO를 통해
   ```

3. **game-state는 DO만 사용**
   ```javascript
   // KV 무시, DO만 반환
   ```

## 나가기 버튼 표시 정책

### 현재
- 게임 중: 숨김 (이탈 방지)
- 대기실: 표시

### 제안
- **게임 중**: 표시 (사용자 선택권)
- **대기실**: 표시
- **브라우저 종료**: 서버 측 자동 감지로 처리

**이유**: 
- 나가기 버튼 숨김은 UX 문제를 해결하지 못함
- 브라우저 종료는 어차피 막을 수 없음
- 서버 측 자동 감지로 처리하는 게 더 나음

## 결론

1. **나가기 버튼과 브라우저 종료는 같은 문제** (DO-KV 동기화)
2. **해결책**: DO를 단일 소스로, KV는 메타데이터만
3. **나가기 버튼**: 표시해도 됨 (서버 측 자동 감지로 처리)
4. **브라우저 종료**: Heartbeat + 서버 측 자동 감지로 처리 (이미 구현됨)
