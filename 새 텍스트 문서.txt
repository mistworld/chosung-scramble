# fbac380 버전 상태 및 문제점 정리

## 📌 현재 버전 정보
- **커밋**: `fbac380`
- **메시지**: `Fix: Time mode polling cleanup, room list stability, entry retry, score instant update`
- **상태**: ✅ 깔끔하게 되돌림 완료

---

## ✅ 이 버전(fbac380)에 실제로 포함된 수정사항

# 시간제 모드 전체 규칙 및 슬롯 동기화 정리

## 📋 시간제 모드 전체 규칙

### 1. 방 생성 및 입장
- **방 생성**: 최소 1명만 있어도 방 생성/유지 가능
- **입장 규칙**:
  - **어떤 상황에서도 입장 가능** (대기실/게임 중/종료 모달 상태 모두)
  - **중복 입장 가능** (같은 플레이어가 나갔다가 다시 입장 가능)
  - **입장과 거의 동시에 슬롯에 반영** (모든 플레이어 화면에 즉시 표시)

### 2. 게임 진행
- **게임 시간**: 180초
- **점수 시스템**:
  - 단어 맞출 때마다 **점수 즉시 반영**
  - 모든 플레이어의 왼쪽 슬롯에 **실시간 점수 표시** (지연 없음)
  - 점수와 이모티콘도 즉시 반영
- **게임 중 입장**: 게임 중에도 입장 가능하며, 남은 시간에 맞춰 함께 플레이 가능

### 3. 퇴장 규칙
- **나가기 버튼**: 항상 활성화, 클릭 시 즉시 퇴장
- **브라우저 종료/F5**: 퇴장 처리
- **퇴장 처리**:
  - **슬롯에서 거의 동시에 제거** (다른 플레이어 화면에도 즉시 반영)
  - 점수/단어 데이터도 즉시 제거
  - **시스템 인식**: 나간 사람은 게임 참여 불가

### 4. 방 유지/삭제
- **방 유지 조건**: **최소 1명만 있어도 유지** (다른 플레이어 입장 대기)
- **방 삭제**: 모든 플레이어가 나갔을 때만 삭제

### 5. 게임 종료 및 결과
- **종료 조건**: 180초 타이머 종료
- **종료 모달**:
  - **게임에 참여한 플레이어만 표시** (브라우저 종료로 나간 플레이어는 제외)
  - 점수순으로 정렬 표시
  - **나간 사람은 순위에서 제외** (모달에 표시 안 함)
- **점수 순위**: 실제 참여자만 포함, 나간 사람은 순위에서 제외

### 6. 방장 시스템
- **방장 결정**:
  - 첫 입장자가 초기 방장
  - **새 게임 시작 시 전판 1등이 새 방장** (재셋팅)
- **방장 권한**:
  - 방장만 "다시하기" 버튼 보임
  - 방장만 "게임 시작" 버튼 보임
  - 비방장은 "방장이 다음 게임을 시작할 때까지 기다려주세요" 메시지 표시
- **방장 승계**: 방장이 나가면 첫 번째 플레이어가 방장

### 7. 새 게임 시작 (다시하기)
- **게임 시작 시**:
  - **비활성 플레이어 제거** (lastSeen 15초 타임아웃 기준, 게임 시작 시점에만)
  - **전판 점수 기준 1등을 방장으로 설정** (players 배열 첫 번째로 이동, 점수 초기화 전에)
  - 점수/단어 데이터 초기화
  - 라운드 번호 증가
- **게임 시작 후**: 타이머 180초부터 카운트다운 시작, 정상 진행

---

## 🔄 슬롯 동기화 규칙

### 핵심 원칙
- **모든 입장/퇴장은 거의 동시에 모든 플레이어 화면에 반영**
- **슬롯 표시 = 시스템 인식** (슬롯에 있으면 게임 참여 가능, 없으면 불가능)

### 입장 시 슬롯 동기화
1. 플레이어 입장 요청 → 서버에서 `players` 배열에 추가
2. **즉시 KV 업데이트** (또는 DO 업데이트)
3. **모든 플레이어의 폴링에서 감지** → 슬롯에 표시
4. **거의 동시에 모든 화면에 반영** (폴링 간격 내)

### 퇴장 시 슬롯 동기화
1. 플레이어 퇴장 (나가기 버튼 or 브라우저 종료)
2. **즉시 서버에서 `players` 배열에서 제거**
3. **즉시 KV 업데이트** (scores, playerWords도 제거)
4. **모든 플레이어의 폴링에서 감지** → 슬롯에서 제거
5. **거의 동시에 모든 화면에 반영**

### 게임 시작 시 슬롯 체크
- 게임 시작 전 현재 상황 리셋
- 비활성 플레이어 제거 (lastSeen 15초 타임아웃)
- 전판 1등을 방장으로 설정 (players 배열 첫 번째로 이동)
- 슬롯 업데이트 → 모든 플레이어 화면에 반영

---

## 🚪 입퇴장 세부 규칙

### 입장 가능한 상황 (어떤 상황에서도 가능해야함. 재입장도 가능)
- ✅ 대기실 (게임 시작 전)
- ✅ 게임 중 (180초 진행 중)
- ✅ 종료 모달 뜬 상태 (게임 종료 후 대기실)
- ✅ 중복 입장 가능 (같은 플레이어가 나갔다가 다시 입장)

### 퇴장 가능한 상황
- ✅ 대기실에서 나가기 버튼 클릭
- ✅ 게임 중 나가기 버튼 클릭
- ✅ 종료 모달 상태에서 나가기 버튼 클릭
- ✅ 브라우저 종료 (어떤 상황에서든)

### 퇴장 처리
- **나가기 버튼**: 즉시 퇴장 처리, 슬롯에서 제거
- **브라우저 종료**: lastSeen 타임아웃 또는 게임 시작 시 정리로 제거
- **슬롯에서 제거 = 현재 게임에서 제외** (현재 라운드 참여 불가, 하지만 **재입장 가능해야함**)

---

## ⚠️ 중요 사항

### 종료 모달 표시 규칙
- **게임 종료 시점의 활성 플레이어만 표시**
- **브라우저 종료로 나간 플레이어는 제외**
- `roomData.players`를 그대로 사용 (lastSeen 체크 불필요)
- 게임 시작 시 이미 비활성 플레이어가 제거되었으므로, 종료 모달에서는 단순히 표시만

### 방장 판단 (방장 판단은 원래 방장이 해도 됨. 그냥 잘 되게만 하면 됨)
- **항상 `roomData.players[0].id` 기준**
- 복잡한 필터링 로직 불필요
- 게임 시작 시 1등이 첫 번째로 이동되므로, 그 이후에는 `players[0]`이 방장. 방장만 다시하기 할 수 있음

### 비활성 플레이어 정리
- **게임 시작 시에만 적용** (new_game 액션)
- lastSeen 15초 타임아웃 기준
- 종료 모달에서는 불필요 (이미 정리됨)

---

## 🎯 현재 문제점 (fbac380 기준)

1. **종료 모달에서 lastSeen 체크로 인한 문제**
   - 정상 플레이어도 제거될 수 있음
   - 해결: `roomData.players`를 그대로 사용

2. **방장 판단 복잡함**
   - 해결: 항상 `roomData.players[0].id` 사용

3. **게임 시작 시 방장 재설정 없음**
   - 해결: 전판 1등을 players 배열 첫 번째로 이동

4. **점수 실시간 반영 문제**
   - 클라이언트는 수정됨 (setTimeout 제거)
   - 서버 측 확인 필요 (POST 후 KV 저장)





---

## 📝 참고사항

- **시간제 모드**: KV 단일 소스 (DO 사용 안 함)
- **턴제 모드**: DO 단일 소스
- **폴링 간격**: 800ms
- **비활성 플레이어 타임아웃**: 15초 (게임 시작 시만 적용, 종료 모달에서는 불필요)

---

## ⚠️ 주의사항

1. 하나를 수정하면 다른 부분이 망가질 수 있으므로 신중하게 수정
2. 시간제 모드와 턴제 모드를 명확히 구분하여 처리
3. 테스트가 어렵다고 하셨으므로, 작은 단위로 수정하고 검증

---

## 🔧 배포 상태

- **Git**: `fbac380` 커밋으로 되돌림 완료
- **Vercel**: Git push 필요 (`git push vercel HEAD:main`)
- **Cloudflare Worker**: `npx wrangler deploy` 필요

---


